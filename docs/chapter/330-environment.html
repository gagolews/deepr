<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<meta content="Deep R Programming" name="citation_title" />
<meta content="Marek Gagolewski" name="citation_author" />
<meta content="2023" name="citation_date" />
<meta content="2023" name="citation_publication_date" />
<meta content="https://deepr.gagolewski.com/deepr.pdf" name="citation_pdf_url" />
<meta content="https://deepr.gagolewski.com" name="citation_public_url" />
<meta content="10.5281/zenodo.7490464" name="citation_doi" />
<meta content="Deep R Programming is a comprehensive and in-depth introductory course on one of the most popular languages for data science. It equips ambitious students, professionals, and researchers with the knowledge and skills to become independent users of this potent environment so that they can tackle any problem related to data wrangling and analytics, numerical computing, statistics, and machine learning. This textbook is a non-profit project. Its online and PDF versions are freely available at https://deepr.gagolewski.com/." name="citation_abstract" />
<meta content="summary" name="twitter:card" />
<meta content="Deep R Programming" name="twitter:title" />
<meta content="Deep R Programming" name="og:title" />
<meta content="Deep R Programming is a comprehensive and in-depth introductory course on one of the most popular languages for data science. It equips ambitious students, professionals, and researchers with the knowledge and skills to become independent users of this potent environment so that they can tackle any problem related to data wrangling and analytics, numerical computing, statistics, and machine learning. This textbook is a non-profit project. Its online and PDF versions are freely available at https://deepr.gagolewski.com/." name="twitter:description" />
<meta content="Deep R Programming is a comprehensive and in-depth introductory course on one of the most popular languages for data science. It equips ambitious students, professionals, and researchers with the knowledge and skills to become independent users of this potent environment so that they can tackle any problem related to data wrangling and analytics, numerical computing, statistics, and machine learning. This textbook is a non-profit project. Its online and PDF versions are freely available at https://deepr.gagolewski.com/." name="og:description" />
<meta content="gagolews/deepr" name="og:site_name" />
<meta content="https://deepr.gagolewski.com" name="og:url" />
<meta content="https://deepr.gagolewski.com/_images/cover.png" name="twitter:image" />
<meta content="https://deepr.gagolewski.com/_images/cover.png" name="og:image" />
<meta content="https://deepr.gagolewski.com" name="DC.identifier" />
<meta content="Marek Gagolewski" name="DC.publisher" />
<meta content="INDEX,FOLLOW" name="robots" />
<meta content="book" name="og:type" />
<meta content="9780645571929" name="og:book:isbn" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="17. Lazy evaluation (**)" href="340-lazy.html" /><link rel="prev" title="15. Unevaluated expressions (*)" href="320-language.html" />
        <link rel="canonical" href="https://deepr.gagolewski.com/chapter/330-environment.html" />

    <link rel="shortcut icon" href="https://www.gagolewski.com/_static/img/deepr.png"/><!-- Generated with Sphinx 7.2.5 and Furo 2023.08.19 -->
        <title>16. Environments and evaluation (*) - Deep R Programming</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../_static/proof.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/katex-math.css?v=91adb8b6" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=36a5483c" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=dd03ec4f" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --admonition-font-size: 95%;
  --admonition-title-font-size: 95%;
  --color-brand-primary: red;
  --color-brand-content: #CC3333;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --admonition-font-size: 95%;
  --admonition-title-font-size: 95%;
  --color-brand-primary: #ff2b53;
  --color-brand-content: #dd3333;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --admonition-font-size: 95%;
  --admonition-title-font-size: 95%;
  --color-brand-primary: #ff2b53;
  --color-brand-content: #dd3333;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">Deep R Programming</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto colour theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky">
<div class="sidebar-logo-container">
  <a class="sidebar-brand" href="../index.html"><img class="sidebar-logo" src="https://www.gagolewski.com/_static/img/deepr.png" alt="Logo"/></a>
</div>

<span class="sidebar-brand-text">
<a class="sidebar-brand" href="../index.html">Deep R Programming</a>
</span>
<div class="sidebar-brand">
An open-access textbook<br />
by <a href='https://www.gagolewski.com/' style="display: contents">Marek Gagolewski</a><br />
v1.0.0.9002
</div>
<form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">About</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.gagolewski.com/">Author</a></li>
<li class="toctree-l1"><a class="reference external" href="https://deepr.gagolewski.com/deepr.pdf">This book in PDF</a></li>
<li class="toctree-l1"><a class="reference internal" href="../order-paper-copy.html">Order a paper copy</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/gagolews/deepr">Report bugs or typos (GitHub)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/gagolews/teaching-data">Datasets</a></li>
<li class="toctree-l1"><a class="reference external" href="https://datawranglingpy.gagolewski.com/">Data wrangling with Python</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Start here</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="000-preface.html">Preface</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Deep</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="110-basics.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="120-numeric.html">2. Numeric vectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="130-logical.html">3. Logical vectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="140-list.html">4. Lists and attributes</a></li>
<li class="toctree-l1"><a class="reference internal" href="150-indexing.html">5. Vector indexing</a></li>
<li class="toctree-l1"><a class="reference internal" href="160-character.html">6. Character vectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="170-function.html">7. Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="180-flow.html">8. Flow of execution</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Deeper</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="210-design.html">9. Designing functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="220-s3.html">10. S3 classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="230-matrix.html">11. Matrices and other arrays</a></li>
<li class="toctree-l1"><a class="reference internal" href="240-data-frame.html">12. Data frames</a></li>
<li class="toctree-l1"><a class="reference internal" href="250-graphics.html">13. Graphics</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Deepest</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="310-compiled.html">14. Interfacing compiled code (**)</a></li>
<li class="toctree-l1"><a class="reference internal" href="320-language.html">15. Unevaluated expressions (*)</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">16. Environments and evaluation (*)</a></li>
<li class="toctree-l1"><a class="reference internal" href="340-lazy.html">17. Lazy evaluation (**)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Appendix</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="998-changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="999-bibliography.html">References</a></li>
</ul>

</div></div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="edit-this-page">
  <a class="muted-link" href="https://github.com/gagolews/deepr" title="Edit this page">
    <svg aria-hidden="true" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <path d="M4 20h4l10.5 -10.5a1.5 1.5 0 0 0 -4 -4l-10.5 10.5v4" />
      <line x1="13.5" y1="6.5" x2="17.5" y2="10.5" />
    </svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto colour theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section class="tex2jax_ignore mathjax_ignore" id="environments-and-evaluation">
<span id="chap-environment"></span><h1><span class="section-number">16. </span>Environments and evaluation (*)<a class="headerlink" href="#environments-and-evaluation" title="Link to this heading">#</a></h1>
<blockquote>
<div><p><em>This open-access textbook
is, and will remain, freely available for everyone’s enjoyment
(also in <a class="reference external" href="https://deepr.gagolewski.com/deepr.pdf">PDF</a>;
a paper copy can also be <a class="reference internal" href="../order-paper-copy.html"><span class="doc std std-doc">ordered</span></a>).
It is a non-profit project. Although available online, it is a whole course,
and should be read from the beginning to the end.
Refer to the <a class="reference internal" href="000-preface.html#chap-preface"><span class="std std-ref">Preface</span></a> for general introductory remarks. Any
<a class="reference external" href="https://github.com/gagolews/deepr">bug/typo reports/fixes</a>
are appreciated. Make sure to check out
<a class="reference external" href="https://datawranglingpy.gagolewski.com/"><em>Minimalist Data Wrangling with Python</em></a>
<span id="id1">[<a class="reference internal" href="999-bibliography.html#id3" title="Gagolewski, M. (2022).  Minimalist Data Wrangling with Python. Zenodo. URL: https://datawranglingpy.gagolewski.com/, DOI: 10.5281/zenodo.6451068.">26</a>]</span> too.</em></p>
</div></blockquote>
<p>In the first part of our book, we discussed the most crucial
<em>basic</em> object types: numeric, logical, and character vectors,
lists (generic vectors), and functions.</p>
<p>In this chapter, we introduce another basic type: <em>environments</em>.
Like lists, they can be classified as recursive data structures;
compare the diagram in <a class="reference internal" href="340-lazy.html#fig-data-types-full"><span class="std std-numref">Figure 17.2</span></a>.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Each object of the type <code class="docutils literal notranslate"><span class="pre">environment</span></code> consists of:</p>
<ul class="simple">
<li><p>a <em>frame</em><a class="footnote-reference brackets" href="#footdf" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a> (<a class="reference internal" href="#sec-frame-env"><span class="std std-numref">Section 16.1</span></a>), which
stores a set of <em>bindings</em> that associate variable names with their
corresponding values; it can be thought of as a container
of named R objects of any type;</p></li>
<li><p>a reference to an <em>enclosing environment</em><a class="footnote-reference brackets" href="#footencpar" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a>
(<a class="reference internal" href="#sec-enclos-env"><span class="std std-numref">Section 16.2.2</span></a>), which might be inspected (recursively!)
when a requested named variable is not found
in the current frame.</p></li>
</ul>
</div>
<p>Even though we rarely interact with them directly (unless we need
a hash table-like data structure with a quick by-name element lookup),
they are crucial for the R interpreter itself.
Namely, we shall soon see that they form the basis
of the <em>environment model of evaluation</em>,
which governs how expressions are computed (<a class="reference internal" href="#sec-env-mod-eval"><span class="std std-numref">Section 16.2</span></a>).</p>
<section id="frames-environments-as-object-containers">
<span id="sec-frame-env"></span><h2><span class="section-number">16.1. </span>Frames: Environments as object containers<a class="headerlink" href="#frames-environments-as-object-containers" title="Link to this heading">#</a></h2>
<p>To create a new, empty environment,
we can call the <strong class="command">new.env</strong> function:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">e1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">new.env</span><span class="p">()</span>
<span class="nf">typeof</span><span class="p">(</span><span class="n">e1</span><span class="p">)</span>
<span class="c1">## [1] &quot;environment&quot;</span>
</pre></div>
</div>
<p>In this section, we treat environments merely as
containers for named objects of any kind, i.e.,
we deal with the <em>frame</em> part thereof.</p>
<p>Let us insert a few elements into <code class="docutils literal notranslate"><span class="pre">e1</span></code>:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">e1</span><span class="p">[[</span><span class="s">&quot;x&quot;</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;x in e1&quot;</span>
<span class="n">e1</span><span class="p">[[</span><span class="s">&quot;y&quot;</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">3</span>
<span class="n">e1</span><span class="p">[[</span><span class="s">&quot;z&quot;</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">NULL</span><span class="w">  </span><span class="c1"># unlike in the case of lists, creates a new element</span>
</pre></div>
</div>
<p>The `<strong class="command">[[</strong>` operator provides us with a <em>named list</em>-like
behaviour also in the case of element extraction:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">e1</span><span class="p">[[</span><span class="s">&quot;x&quot;</span><span class="p">]]</span>
<span class="c1">## [1] &quot;x in e1&quot;</span>
<span class="n">e1</span><span class="p">[[</span><span class="s">&quot;spam&quot;</span><span class="p">]]</span><span class="w">  </span><span class="c1"># does not exist</span>
<span class="c1">## NULL</span>
<span class="p">(</span><span class="n">e1</span><span class="p">[[</span><span class="s">&quot;y&quot;</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">e1</span><span class="p">[[</span><span class="s">&quot;y&quot;</span><span class="p">]]</span><span class="o">*</span><span class="m">10</span><span class="p">)</span><span class="w">  </span><span class="c1"># replace with new content</span>
<span class="c1">## [1] 10 20 30</span>
</pre></div>
</div>
<section id="printing">
<h3><span class="section-number">16.1.1. </span>Printing<a class="headerlink" href="#printing" title="Link to this heading">#</a></h3>
<p>Printing an environment leads to a quite awkward result:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">print</span><span class="p">(</span><span class="n">e1</span><span class="p">)</span><span class="w">  </span><span class="c1"># same with str(e1)</span>
<span class="c1">## &lt;environment: 0x55b5bd419fc0&gt;</span>
</pre></div>
</div>
<p>It is the address where <code class="docutils literal notranslate"><span class="pre">e1</span></code> is stored in the computer’s memory.
It can serve as the environment’s unique identifier.</p>
<p>As we have said, these objects are of rather <em>internal</em> interest.
Thus, such an esoteric message was perhaps a good design choice;
it wards off novices. However, we can easily get the list of objects stored
inside the container by calling <strong class="command">names</strong>:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">names</span><span class="p">(</span><span class="n">e1</span><span class="p">)</span><span class="w">  </span><span class="c1"># but attr(e1, &quot;names&quot;) is not set</span>
<span class="c1">## [1] &quot;x&quot; &quot;y&quot; &quot;z&quot;</span>
</pre></div>
</div>
<p>Moreover, <strong class="command">length</strong> gives the number of bindings in the frame:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">length</span><span class="p">(</span><span class="n">e1</span><span class="p">)</span>
<span class="c1">## [1] 3</span>
</pre></div>
</div>
</section>
<section id="environments-vs-named-lists">
<span id="sec-env-vs-list"></span><h3><span class="section-number">16.1.2. </span>Environments vs named lists<a class="headerlink" href="#environments-vs-named-lists" title="Link to this heading">#</a></h3>
<p>Environment frames, in some sense, can be thought of
as named lists, but the set of admissible operations is severely restricted.
In particular, we cannot extract more than one element
at the same time using the index operator:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">e1</span><span class="p">[</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;y&quot;</span><span class="p">)]</span><span class="w">  </span><span class="c1"># but see the `mget` function</span>
<span class="c1">## Error in e1[c(&quot;x&quot;, &quot;y&quot;)]: object of type &#39;environment&#39; is not subsettable</span>
</pre></div>
</div>
<p>nor can we refer to the elements by position:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">e1</span><span class="p">[[</span><span class="m">1</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;bad key&quot;</span>
<span class="c1">## Error in e1[[1]] &lt;- &quot;bad key&quot;: wrong args for environment subassignment</span>
</pre></div>
</div>
<div class="proof proof-type-exercise" id="id29">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.1</span>
        
    </div><div class="proof-content">
<p>Check if <strong class="command">lapply</strong> and <strong class="command">Map</strong> can be applied
directly on environments.
Also, can we iterate over their elements using a <strong class="command">for</strong> loop?</p>
</div></div><p>Still, named lists can be converted to environments
and vice versa using <strong class="command">as.list</strong> and <strong class="command">as.environment</strong>.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">as.list</span><span class="p">(</span><span class="n">e1</span><span class="p">)</span>
<span class="c1">## $x</span>
<span class="c1">## [1] &quot;x in e1&quot;</span>
<span class="c1">##</span>
<span class="c1">## $y</span>
<span class="c1">## [1] 10 20 30</span>
<span class="c1">##</span>
<span class="c1">## $z</span>
<span class="c1">## NULL</span>
<span class="nf">as.environment</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="m">42</span><span class="p">,</span><span class="w"> </span><span class="n">whatever</span><span class="o">=</span><span class="s">&quot;it&#39;s not going to be printed anyway&quot;</span><span class="p">))</span>
<span class="c1">## &lt;environment: 0x55b5bcffd288&gt;</span>
<span class="nf">as.list</span><span class="p">(</span><span class="nf">as.environment</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="o">=</span><span class="m">3</span><span class="p">)))</span><span class="w">  </span><span class="c1"># no duplicates allowed</span>
<span class="c1">## $y</span>
<span class="c1">## [1] 2</span>
<span class="c1">##</span>
<span class="c1">## $x</span>
<span class="c1">## [1] 3</span>
</pre></div>
</div>
</section>
<section id="hash-maps-fast-element-lookup-by-name">
<h3><span class="section-number">16.1.3. </span>Hash maps: Fast element lookup by name<a class="headerlink" href="#hash-maps-fast-element-lookup-by-name" title="Link to this heading">#</a></h3>
<p>Environment frames are internally implemented
using hash tables (hash maps; see, e.g., <span id="id4">[<a class="reference internal" href="999-bibliography.html#id68" title="Cormen, T.H., Leiserson, C.E., Rivest, R.L., and Stein, C. (2009).  Introduction to Algorithms. MIT Press and McGraw-Hill.">14</a>, <a class="reference internal" href="999-bibliography.html#id34" title="Knuth, D.E. (1997).  The Art of Computer Programming III: Sorting and Searching. Addison-Wesley.">41</a>]</span>)
with character string keys.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>A <em>hash table</em> is a data structure that implements
a very quick<a class="footnote-reference brackets" href="#footquickhash" id="id5" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a> lookup and insertion
of individual elements <em>by name</em>.</p>
</div>
<p>The above comes at a price, including what we have already observed above:</p>
<ul class="simple">
<li><p>the elements are not ordered in any particular way:
they cannot be referred to via a numeric index;</p></li>
<li><p>all element names must be unique.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A list may be considered a <em>sequence</em>,
but an environment frame is only, in fact, a <em>set</em> (a bag) of
<em>key-value pairs</em>.
In most numerical computing applications,
we would rather store, iterate over, and process all the elements
<em>in order</em>, hence the greater prevalence of the former.
Lists still implement the element lookup by name, even though it
is slightly slower<a class="footnote-reference brackets" href="#footlisttime" id="id6" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a>. However, they are much more universal.</p>
</div>
<div class="proof proof-type-example" id="id30">

    <div class="proof-title">
        <span class="proof-type">Example 16.2</span>
        
    </div><div class="proof-content">
<p>A natural use case of manually-created environment frames
deals with grouping a series of objects identified by character string keys.
Consider a simple pseudocode for counting the number of occurrences
of objects in a given container:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">for </span><span class="p">(</span><span class="n">key</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">some_container</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nf">if </span><span class="p">(</span><span class="o">!</span><span class="nf">is.null</span><span class="p">(</span><span class="n">counter</span><span class="p">[[</span><span class="s">&quot;key&quot;</span><span class="p">]]))</span>
<span class="w">        </span><span class="n">counter</span><span class="p">[[</span><span class="s">&quot;key&quot;</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">counter</span><span class="p">[[</span><span class="s">&quot;key&quot;</span><span class="p">]]</span><span class="m">+1</span>
<span class="w">    </span><span class="n">else</span>
<span class="w">        </span><span class="n">counter</span><span class="p">[[</span><span class="s">&quot;key&quot;</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Let us assume that <code class="docutils literal notranslate"><span class="pre">some_container</span></code> is large,
e.g., it is generated on the fly by reading a data stream of size <span class="math">\(n\)</span>.
The runtime of the above algorithm will depend on the
data structure used.
If the <code class="docutils literal notranslate"><span class="pre">counter</span></code> is a list, then, theoretically, the worst-case performance
will be <span class="math">\(O(n^2)\)</span> (if all keys are unique).
On the other hand, for environments, it will be faster
by one order magnitude: down to amortised <span class="math">\(O(n)\)</span>.</p>
</div></div><div class="proof proof-type-exercise" id="id31">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.3</span>
        
    </div><div class="proof-content">
<p>Implement a test function according to the above pseudocode
and benchmark the two data structures
using <strong class="command">proc.time</strong> on example data.</p>
</div></div><div class="proof proof-type-exercise" id="id32">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.4</span>
        
    </div><div class="proof-content">
<p>(*)
Determine the number of unique text lines in a huge file
(assuming that the set of unique text lines fits into memory,
but the file itself does not).
Also, determine the five most frequently occurring text lines.</p>
</div></div></section>
<section id="call-by-value-copy-on-demand-not-for-environments">
<span id="sec-copy-on-demand"></span><h3><span class="section-number">16.1.4. </span>Call by value, copy on demand: Not for environments<a class="headerlink" href="#call-by-value-copy-on-demand-not-for-environments" title="Link to this heading">#</a></h3>
<p>Given any object <code class="docutils literal notranslate"><span class="pre">x</span></code>, when we issue:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">x</span>
</pre></div>
</div>
<p>its copy<a class="footnote-reference brackets" href="#footdelayed" id="id7" role="doc-noteref"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></a> is made so that <code class="docutils literal notranslate"><span class="pre">y</span></code> and <code class="docutils literal notranslate"><span class="pre">x</span></code> are independent.
In other words, any change to the state of <code class="docutils literal notranslate"><span class="pre">x</span></code> (or <code class="docutils literal notranslate"><span class="pre">y</span></code>)
is not reflected in <code class="docutils literal notranslate"><span class="pre">y</span></code> (or <code class="docutils literal notranslate"><span class="pre">x</span></code>).
For instance:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>
<span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">x</span>
<span class="n">y</span><span class="p">[[</span><span class="s">&quot;a&quot;</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">y</span><span class="p">[[</span><span class="s">&quot;a&quot;</span><span class="p">]]</span><span class="m">+1</span>
<span class="nf">print</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="c1">## $a</span>
<span class="c1">## [1] 2</span>
<span class="nf">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w">  </span><span class="c1"># not affected: `x` and `y` are independent</span>
<span class="c1">## $a</span>
<span class="c1">## [1] 1</span>
</pre></div>
</div>
<p>The same happens with arguments that we pass to the functions:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">mod</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w">  </span><span class="c1"># it is like: local_y &lt;- passed_argument</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">y</span><span class="p">[[</span><span class="n">key</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">y</span><span class="p">[[</span><span class="n">key</span><span class="p">]]</span><span class="m">+1</span>
<span class="w">    </span><span class="n">y</span>
<span class="p">}</span>

<span class="nf">mod</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;a&quot;</span><span class="p">)[[</span><span class="s">&quot;a&quot;</span><span class="p">]]</span><span class="w">  </span><span class="c1"># returns a modified copy of `x`</span>
<span class="c1">## [1] 2</span>
<span class="n">x</span><span class="p">[[</span><span class="s">&quot;a&quot;</span><span class="p">]]</span><span class="w">  </span><span class="c1"># not affected</span>
<span class="c1">## [1] 1</span>
</pre></div>
</div>
<p>We can thus say that R imitates the <em>pass-by-value</em> strategy here.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Environments are the only<a class="footnote-reference brackets" href="#foottrickery" id="id8" role="doc-noteref"><span class="fn-bracket">[</span>6<span class="fn-bracket">]</span></a> objects that follow
the assign- and pass-by-reference strategies.</p>
</div>
<p>In other words, if we perform:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.environment</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">x</span>
</pre></div>
</div>
<p>then the names <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> are bound to the same object
in the computer’s memory:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="c1">## &lt;environment: 0x55b5bcb31740&gt;</span>
<span class="nf">print</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="c1">## &lt;environment: 0x55b5bcb31740&gt;</span>
</pre></div>
</div>
<p>Therefore:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">y</span><span class="p">[[</span><span class="s">&quot;a&quot;</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">y</span><span class="p">[[</span><span class="s">&quot;a&quot;</span><span class="p">]]</span><span class="m">+1</span>
<span class="nf">print</span><span class="p">(</span><span class="n">y</span><span class="p">[[</span><span class="s">&quot;a&quot;</span><span class="p">]])</span>
<span class="c1">## [1] 2</span>
<span class="nf">print</span><span class="p">(</span><span class="n">x</span><span class="p">[[</span><span class="s">&quot;a&quot;</span><span class="p">]])</span><span class="w">  </span><span class="c1"># `x` is `y`, `y` is `x`</span>
<span class="c1">## [1] 2</span>
</pre></div>
</div>
<p>The same happens when we pass an environment to a function:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">mod</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;a&quot;</span><span class="p">)[[</span><span class="s">&quot;a&quot;</span><span class="p">]]</span><span class="w">  </span><span class="c1"># pass-by-reference (`y` is `x`, remember?)</span>
<span class="c1">## [1] 3</span>
<span class="n">x</span><span class="p">[[</span><span class="s">&quot;a&quot;</span><span class="p">]]</span><span class="w">   </span><span class="c1"># `x` has changed</span>
<span class="c1">## [1] 3</span>
</pre></div>
</div>
<p>Thus, any changes we make to an environment passed as an
argument to a function will be visible <em>outside</em> the call.
This minimises time and memory use in certain situations.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>(*)
For efficiency reasons, when we write “<code class="docutils literal notranslate"><span class="pre">y</span> <span class="pre">&lt;-</span> <span class="pre">x</span></code>” ,
a copy of <code class="docutils literal notranslate"><span class="pre">x</span></code> (unless it is an environment)
is created only if it is absolutely necessary.</p>
<p>Here is some benchmarking of the <em>copy-on-demand</em> mechanism.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">n</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">100000000</span><span class="w">  </span><span class="c1"># like, a lot</span>
</pre></div>
</div>
<p>Creation of a new large numeric vector:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">t0</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">proc.time</span><span class="p">();</span><span class="w">  </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">numeric</span><span class="p">(</span><span class="n">n</span><span class="p">);</span><span class="w">  </span><span class="nf">proc.time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t0</span>
<span class="c1">##    user  system elapsed</span>
<span class="c1">##   0.853   1.993   2.852</span>
</pre></div>
</div>
<p>Creation of a (delayed) copy is instant:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">t0</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">proc.time</span><span class="p">();</span><span class="w">  </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w">           </span><span class="nf">proc.time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t0</span>
<span class="c1">##    user  system elapsed</span>
<span class="c1">##       0       0       0</span>
</pre></div>
</div>
<p>We definitely did not duplicate the <code class="docutils literal notranslate"><span class="pre">n</span></code> data cells.</p>
<p>Copy-on-demand is implemented using some simple <em>reference counting</em>;
compare <a class="reference internal" href="310-compiled.html#sec-memory-management"><span class="std std-numref">Section 14.2.4</span></a>. We can inspect that
<code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> point to the same address in memory by calling:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">.Internal</span><span class="p">(</span><span class="nf">inspect</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="w">  </span><span class="c1"># internal function - do not use it</span>
<span class="c1">## @7efba1134010 14 REALSXP g0c7 [REF(2)] (len=1000000000, tl=0) 0,0,0,0,...</span>
<span class="nf">.Internal</span><span class="p">(</span><span class="nf">inspect</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
<span class="c1">## @7efba1134010 14 REALSXP g0c7 [REF(2)] (len=1000000000, tl=0) 0,0,0,0,...</span>
</pre></div>
</div>
<p>The actual copying is only triggered when we try to modify <code class="docutils literal notranslate"><span class="pre">x</span></code> or <code class="docutils literal notranslate"><span class="pre">y</span></code>.
This is when they need to be separated.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">t0</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">proc.time</span><span class="p">();</span><span class="w">  </span><span class="n">y</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="p">;</span><span class="w">        </span><span class="nf">proc.time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t0</span>
<span class="c1">##    user  system elapsed</span>
<span class="c1">##   1.227   1.910   3.142</span>
</pre></div>
</div>
<p>Now <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> are different objects.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">.Internal</span><span class="p">(</span><span class="nf">inspect</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="c1">## @7efba1134010 14 REALSXP g0c7 [MARK,REF(1)] (len=1000000000, tl=0) 0,0,...</span>
<span class="nf">.Internal</span><span class="p">(</span><span class="nf">inspect</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
<span class="c1">## @7ef9c43ce010 14 REALSXP g0c7 [MARK,REF(1)] (len=1000000000, tl=0) 1,0,...</span>
</pre></div>
</div>
<p>The elapsed time is similar to that needed to create <code class="docutils literal notranslate"><span class="pre">x</span></code> from scratch.
Further modifications will already be quick:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">t0</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">proc.time</span><span class="p">();</span><span class="w">  </span><span class="n">y</span><span class="p">[</span><span class="m">2</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">2</span><span class="p">;</span><span class="w">        </span><span class="nf">proc.time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t0</span>
<span class="c1">##    user  system elapsed</span>
<span class="c1">##   0.000   0.001   0.000</span>
</pre></div>
</div>
</div>
</section>
<section id="a-note-on-reference-classes">
<span id="sec-refclass"></span><h3><span class="section-number">16.1.5. </span>A note on reference classes (**)<a class="headerlink" href="#a-note-on-reference-classes" title="Link to this heading">#</a></h3>
<p>In <a class="reference internal" href="220-s3.html#sec-s4"><span class="std std-numref">Section 10.5</span></a>, we briefly mentioned the S4 system for object-orientated
programming. We also have access to its variant, called
<em>reference classes</em><a class="footnote-reference brackets" href="#footr5" id="id9" role="doc-noteref"><span class="fn-bracket">[</span>7<span class="fn-bracket">]</span></a>, which was first introduced in R version 2.12.0.
Reference classes are implemented using S4 classes, with the data part
being of the type <code class="docutils literal notranslate"><span class="pre">environment</span></code>. They give a more typical OOP experience,
where methods can modify the data they act on in place.</p>
<p>They are theoretically interesting concepts on their own
and may be quite appealing to package developers with C++ or Java background.
Nevertheless, in the current author’s opinion, such classes are alien
citizens of our environment, violating its <em>functional</em> nature.
Therefore, we will not be discussing them here.</p>
<p>A curious reader is referred to <strong class="command">help</strong><code class="code docutils literal notranslate"><span class="pre">(&quot;ReferenceClasses&quot;)</span></code>
and Chapters 9 and 11 of <span id="id10">[<a class="reference internal" href="999-bibliography.html#id21" title="Chambers, J.M. (2016).  Extending R. Chapman &amp; Hall.">11</a>]</span> for more details.</p>
</section>
</section>
<section id="the-environment-model-of-evaluation">
<span id="sec-env-mod-eval"></span><h2><span class="section-number">16.2. </span>The environment model of evaluation<a class="headerlink" href="#the-environment-model-of-evaluation" title="Link to this heading">#</a></h2>
<p>In <a class="reference internal" href="320-language.html#chap-language"><span class="std std-numref">Chapter 15</span></a>, we said that
there are three types of expressions: constants  (e.g., <code class="docutils literal notranslate"><span class="pre">1</span></code> and <code class="docutils literal notranslate"><span class="pre">&quot;spam&quot;</span></code>),
names (e.g., <code class="docutils literal notranslate"><span class="pre">x</span></code>, `<code class="docutils literal notranslate"><span class="pre">+</span></code>`, and <code class="docutils literal notranslate"><span class="pre">spam</span></code>),
and calls (like <strong class="command">f</strong><code class="code docutils literal notranslate"><span class="pre">(x,</span> <span class="pre">1)</span></code>).</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Names (symbols) have no meaning by themselves.
The <em>meaning</em> of a name always depends on the context,
which is specified by an environment.</p>
</div>
<p>Consider a simple expression that merely consists of the name <code class="docutils literal notranslate"><span class="pre">x</span></code>:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">expr_x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">quote</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>Let us define two environments that bind the name <code class="docutils literal notranslate"><span class="pre">x</span></code> to
two different constants.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">e1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.environment</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="m">1</span><span class="p">))</span>
<span class="n">e2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.environment</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">&quot;spam&quot;</span><span class="p">))</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>An expression is evaluated <em>within</em> a specific environment.</p>
</div>
<p>Let us call <strong class="command">eval</strong> on the above.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">eval</span><span class="p">(</span><span class="n">expr_x</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">e1</span><span class="p">)</span><span class="w">  </span><span class="c1"># evaluate `x` within environment e1</span>
<span class="c1">## [1] 1</span>
<span class="nf">eval</span><span class="p">(</span><span class="n">expr_x</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">e2</span><span class="p">)</span><span class="w">  </span><span class="c1"># evaluate the same `x` within environment e2</span>
<span class="c1">## [1] &quot;spam&quot;</span>
</pre></div>
</div>
<p>The very same expression has two different meanings, depending on the
<em>context</em>. This is quite like in the so-called real life:
“I’m good” can mean “I don’t need anything” but also
“My virtues are plentiful”. It all depends on who and when is asking, i.e.,
in which <em>environment</em> we <em>evaluate</em> the said sentence.</p>
<p>We call this the <em>environment model of evaluation</em>,
a notion that R authors have borrowed from a Lisp-like
language called Scheme<a class="footnote-reference brackets" href="#footlisp" id="id11" role="doc-noteref"><span class="fn-bracket">[</span>8<span class="fn-bracket">]</span></a>
(see Section 3.2 of <span id="id12">[<a class="reference internal" href="999-bibliography.html#id16" title="Abelson, H., Sussman, G.J., and Sussman, J. (1996).  Structure and Interpretation of Computer Programs. MIT Press.">1</a>]</span> and Section 6 of <span id="id13">[<a class="reference internal" href="999-bibliography.html#id11" title="R Development Core Team. (2023).  R Language Definition. URL: https://CRAN.R-project.org/doc/manuals/r-release/R-lang.html.">67</a>]</span>).</p>
<section id="getting-the-current-environment">
<span id="sec-ls"></span><h3><span class="section-number">16.2.1. </span>Getting the current environment<a class="headerlink" href="#getting-the-current-environment" title="Link to this heading">#</a></h3>
<p>By default, expressions are evaluated in the <em>current</em> environment,
which can fetch by calling:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">sys.frame</span><span class="p">(</span><span class="nf">sys.nframe</span><span class="p">())</span><span class="w">  </span><span class="c1"># get the current environment</span>
<span class="c1">## &lt;environment: R_GlobalEnv&gt;</span>
</pre></div>
</div>
<p>We are working <em>on the R console</em>. Hence, the current one is the <em>global</em>
environment (user workspace). We can access it from anywhere by calling
<strong class="command">globalenv</strong> or referring to the `<code class="docutils literal notranslate"><span class="pre">.GlobalEnv</span></code>` object.</p>
<div class="proof proof-type-example" id="id33">

    <div class="proof-title">
        <span class="proof-type">Example 16.5</span>
        
    </div><div class="proof-content">
<p>Calling any operation, for instance<a class="footnote-reference brackets" href="#footassign" id="id14" role="doc-noteref"><span class="fn-bracket">[</span>9<span class="fn-bracket">]</span></a>:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;spammity spam&quot;</span>
</pre></div>
</div>
<p>means evaluating it <em>within the current environment</em>:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">eval</span><span class="p">(</span><span class="nf">quote</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;spammity spam&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="nf">sys.frame</span><span class="p">(</span><span class="nf">sys.nframe</span><span class="p">()))</span>
</pre></div>
</div>
<p>Here, we bound the name <code class="docutils literal notranslate"><span class="pre">x</span></code> to the string <code class="docutils literal notranslate"><span class="pre">&quot;spammity</span> <span class="pre">spam&quot;</span></code> in
the current environment’s frame:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">sys.frame</span><span class="p">(</span><span class="nf">sys.nframe</span><span class="p">())[[</span><span class="s">&quot;x&quot;</span><span class="p">]]</span><span class="w">  </span><span class="c1"># yes, `x` is in the current environment now</span>
<span class="c1">## [1] &quot;spammity spam&quot;</span>
<span class="nf">globalenv</span><span class="p">()[[</span><span class="s">&quot;x&quot;</span><span class="p">]]</span><span class="w">  </span><span class="c1"># because the global environment is the current one here</span>
<span class="c1">## [1] &quot;spammity spam&quot;</span>
</pre></div>
</div>
<p>Therefore, when we now refer to <code class="docutils literal notranslate"><span class="pre">x</span></code> (from within the current environment):</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="w">  </span><span class="c1"># eval(quote(x), envir=sys.frame(sys.nframe()))</span>
<span class="c1">## [1] &quot;spammity spam&quot;</span>
</pre></div>
</div>
<p>precisely the above named object is fetched.</p>
</div></div><div class="proof proof-type-exercise" id="id34">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.6</span>
        
    </div><div class="proof-content">
<p><strong class="command">save.image</strong> saves the current workspace,
i.e., the global environment, by default, to the file named <code class="file docutils literal notranslate"><span class="pre">.Rdata</span></code>.
Test this function in combination with <strong class="command">load</strong>.</p>
</div></div><div class="admonition note">
<p class="admonition-title">Note</p>
<p>Names starting with a dot are <em>hidden</em>.
<strong class="command">ls</strong>, a function to fetch all names registered within
a given environment, does not list them by default.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">.test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;spam&quot;</span>
<span class="nf">ls</span><span class="p">()</span><span class="w">  </span><span class="c1"># list all names in the current environment, i.e., the global one</span>
<span class="c1">## [1] &quot;e1&quot;     &quot;e2&quot;     &quot;expr_x&quot; &quot;mod&quot;    &quot;x&quot;      &quot;y&quot;</span>
</pre></div>
</div>
<p>Compare the above with:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">ls</span><span class="p">(</span><span class="n">all.names</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
<span class="c1">## [1] &quot;.Random.seed&quot; &quot;.test&quot;        &quot;e1&quot;           &quot;e2&quot;</span>
<span class="c1">## [5] &quot;expr_x&quot;       &quot;mod&quot;          &quot;x&quot;            &quot;y&quot;</span>
</pre></div>
</div>
<p>On a side note, `<code class="docutils literal notranslate"><span class="pre">.Random.seed</span></code>` stores the current pseudorandom
number generator’s seed; compare <a class="reference internal" href="120-numeric.html#sec-pseudorandom"><span class="std std-numref">Section 2.1.5</span></a>.</p>
</div>
</section>
<section id="enclosures-enclosures-thereof-etc">
<span id="sec-enclos-env"></span><h3><span class="section-number">16.2.2. </span>Enclosures, enclosures thereof, etc.<a class="headerlink" href="#enclosures-enclosures-thereof-etc" title="Link to this heading">#</a></h3>
<p>To show that there is much more to the environment model
of evaluation than what we mentioned above,
let us try to evaluate an expression featuring two names:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">e2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.environment</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">&quot;spam&quot;</span><span class="p">))</span><span class="w">  </span><span class="c1"># once again (a reminder)</span>
<span class="n">expr_comp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">quote</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="s">&quot;eggs&quot;</span><span class="p">)</span>
<span class="nf">eval</span><span class="p">(</span><span class="n">expr_comp</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">e2</span><span class="p">)</span><span class="w">  </span><span class="c1"># &quot;spam&quot; &lt; &quot;eggs&quot;</span>
<span class="c1">## Error in x &lt; &quot;eggs&quot;: could not find function &quot;&lt;&quot;</span>
</pre></div>
</div>
<p>The meaning of any constant (here, <code class="docutils literal notranslate"><span class="pre">&quot;spam&quot;</span></code>) is context-independent.
The environment provided specifies the name <code class="docutils literal notranslate"><span class="pre">x</span></code> but does
not define `<strong class="command">&lt;</strong>`. Hence the error.</p>
<p>Nonetheless, we <em>feel</em> that we know the meaning
of `<strong class="command">&lt;</strong>`. It is a relational operator, obviously, isn’t it?
To increase the confusion, let us highlight that our experience-grounded
intuition is true in the following context:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">e3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">new.env</span><span class="p">()</span>
<span class="n">e3</span><span class="p">[[</span><span class="s">&quot;x&quot;</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;bacon&quot;</span>
<span class="nf">eval</span><span class="p">(</span><span class="n">expr_comp</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">e3</span><span class="p">)</span><span class="w">  </span><span class="c1"># &quot;bacon&quot; &lt; &quot;eggs&quot;</span>
<span class="c1">## [1] TRUE</span>
</pre></div>
</div>
<p>So where does the name `<strong class="command">&lt;</strong>` come from?
It is neither included in <code class="docutils literal notranslate"><span class="pre">e2</span></code> nor <code class="docutils literal notranslate"><span class="pre">e3</span></code>:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">e2</span><span class="p">[[</span><span class="s">&quot;&lt;&quot;</span><span class="p">]]</span>
<span class="c1">## NULL</span>
<span class="n">e3</span><span class="p">[[</span><span class="s">&quot;&lt;&quot;</span><span class="p">]]</span>
<span class="c1">## NULL</span>
</pre></div>
</div>
<p>Is `<strong class="command">&lt;</strong>` hardcoded somewhere?
Or is it also dependent on the context?
Why is it <em>visible</em> when evaluating
an expression within <code class="docutils literal notranslate"><span class="pre">e3</span></code> but not in <code class="docutils literal notranslate"><span class="pre">e2</span></code>?</p>
<div style="margin-top: 1em"></div><p>Studying <strong class="command">help</strong><code class="code docutils literal notranslate"><span class="pre">(&quot;[[&quot;)</span></code> (see the <em>Environments</em> section),
we discover that <code class="docutils literal notranslate"><span class="pre">e3[[&quot;&lt;&quot;]]</span></code> is equivalent to a call to
<strong class="command">get</strong><code class="code docutils literal notranslate"><span class="pre">(&quot;&lt;&quot;,</span> <span class="pre">envir=e3,</span> <span class="pre">inherits=FALSE)</span></code>.
In <strong class="command">help</strong><code class="code docutils literal notranslate"><span class="pre">(&quot;get&quot;)</span></code>, we read that if the <code class="docutils literal notranslate"><span class="pre">inherits</span></code> argument
is set to <code class="docutils literal notranslate"><span class="pre">TRUE</span></code> (which is the default in <strong class="command">get</strong>), then
<em>the enclosing frames of the given environment are searched as well</em>.</p>
<p>Continuing the example from the previous subsection:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">get</span><span class="p">(</span><span class="s">&quot;&lt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">e2</span><span class="p">)</span><span class="w">  </span><span class="c1"># inherits=TRUE</span>
<span class="c1">## Error in get(&quot;&lt;&quot;, envir = e2): object &#39;&lt;&#39; not found</span>
<span class="nf">get</span><span class="p">(</span><span class="s">&quot;&lt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">e3</span><span class="p">)</span><span class="w">  </span><span class="c1"># inherits=TRUE</span>
<span class="c1">## function (e1, e2)  .Primitive(&quot;&lt;&quot;)</span>
</pre></div>
</div>
<p>And indeed, we see that `<strong class="command">&lt;</strong>` is <em>reachable</em> from
<code class="docutils literal notranslate"><span class="pre">e3</span></code> but not from <code class="docutils literal notranslate"><span class="pre">e2</span></code>. It means that <code class="docutils literal notranslate"><span class="pre">e3</span></code> <em>points to</em> another
environment where further information should be sought
if the current container is left empty-handed.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The reference (pointer) to the <em>enclosing environment</em>
is integral to each environment (alongside a <em>frame</em> of objects).
It can be fetched and set using the <strong class="command">parent.env</strong> function.</p>
</div>
</section>
<section id="missing-names-are-sought-in-enclosing-environments">
<h3><span class="section-number">16.2.3. </span>Missing names are sought in enclosing environments<a class="headerlink" href="#missing-names-are-sought-in-enclosing-environments" title="Link to this heading">#</a></h3>
<p>To understand the idea of enclosing environments better,
let us create two new environments
whose enclosures are explicitly set as follows:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">e4</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">new.env</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">e3</span><span class="p">))</span>
<span class="c1">## &lt;environment: 0x55b5baf70198&gt;</span>
<span class="p">(</span><span class="n">e5</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">new.env</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">e4</span><span class="p">))</span>
<span class="c1">## &lt;environment: 0x55b5bbddb2c8&gt;</span>
</pre></div>
</div>
<p>To verify that everything is in order, let us inspect
the following:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">print</span><span class="p">(</span><span class="n">e3</span><span class="p">)</span><span class="w">  </span><span class="c1"># this is the address of e3</span>
<span class="c1">## &lt;environment: 0x55b5bd2ae008&gt;</span>
<span class="nf">parent.env</span><span class="p">(</span><span class="n">e4</span><span class="p">)</span><span class="w">  </span><span class="c1"># e3 is the enclosing environment of e4</span>
<span class="c1">## &lt;environment: 0x55b5bd2ae008&gt;</span>
<span class="nf">parent.env</span><span class="p">(</span><span class="n">e5</span><span class="p">)</span><span class="w">  </span><span class="c1"># e4 is the enclosing environment of e5</span>
<span class="c1">## &lt;environment: 0x55b5baf70198&gt;</span>
</pre></div>
</div>
<p>Also, let us bind two different objects to the name <code class="docutils literal notranslate"><span class="pre">y</span></code> in <code class="docutils literal notranslate"><span class="pre">e5</span></code> and <code class="docutils literal notranslate"><span class="pre">e3</span></code>.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">e5</span><span class="p">[[</span><span class="s">&quot;y&quot;</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;spam&quot;</span>
<span class="n">e3</span><span class="p">[[</span><span class="s">&quot;y&quot;</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">()</span><span class="w"> </span><span class="s">&quot;a function `y` in e3&quot;</span>
</pre></div>
</div>
<p>The current state of matters is depicted in <a class="reference internal" href="#fig-envirs1"><span class="std std-numref">Figure 16.1</span></a>.</p>
<figure class="align-default" id="id35">
<span id="fig-envirs1"></span><img alt="../_images/envirs1.png" src="../_images/envirs1.png" />
<figcaption>
<p><span class="caption-number">Figure 16.1 </span><span class="caption-text">Example environments and their enclosures (original setting).</span><a class="headerlink" href="#id35" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>Let us evaluate the <code class="docutils literal notranslate"><span class="pre">y</span></code> name in the above environments:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">expr_y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">quote</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="nf">eval</span><span class="p">(</span><span class="n">expr_y</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">e3</span><span class="p">)</span>
<span class="c1">## function() &quot;a function `y` in e3&quot;</span>
<span class="nf">eval</span><span class="p">(</span><span class="n">expr_y</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">e5</span><span class="p">)</span>
<span class="c1">## [1] &quot;spam&quot;</span>
</pre></div>
</div>
<p>No surprises yet. However, evaluating it in <code class="docutils literal notranslate"><span class="pre">e4</span></code>, which does not define
<code class="docutils literal notranslate"><span class="pre">y</span></code>, yields:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">eval</span><span class="p">(</span><span class="n">expr_y</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">e4</span><span class="p">)</span>
<span class="c1">## function() &quot;a function `y` in e3&quot;</span>
</pre></div>
</div>
<p>It returned <code class="docutils literal notranslate"><span class="pre">y</span></code> from <code class="docutils literal notranslate"><span class="pre">e4</span></code>’s enclosure, <code class="docutils literal notranslate"><span class="pre">e3</span></code>.</p>
<p>Let us play about with the enclosures of <code class="docutils literal notranslate"><span class="pre">e5</span></code> and <code class="docutils literal notranslate"><span class="pre">e4</span></code>
so that we obtain the setting depicted in <a class="reference internal" href="#fig-envirs2"><span class="std std-numref">Figure 16.2</span></a>:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">parent.env</span><span class="p">(</span><span class="n">e5</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">e3</span>
<span class="nf">parent.env</span><span class="p">(</span><span class="n">e4</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">e5</span>
</pre></div>
</div>
<figure class="align-default" id="id36">
<span id="fig-envirs2"></span><img alt="../_images/envirs2.png" src="../_images/envirs2.png" />
<figcaption>
<p><span class="caption-number">Figure 16.2 </span><span class="caption-text">Example environments and their enclosures (after the change made).</span><a class="headerlink" href="#id36" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>Evaluating <code class="docutils literal notranslate"><span class="pre">y</span></code> again in the same <code class="docutils literal notranslate"><span class="pre">e4</span></code> nourishes a very different result:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">eval</span><span class="p">(</span><span class="n">expr_y</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">e4</span><span class="p">)</span>
<span class="c1">## [1] &quot;spam&quot;</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Names referred to in an expression but missing in the current environment
will be sought in their enclosure(s) <em>until</em> successful.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Here are the functions related to searching within and modifying
environments that optionally allow for continuing explorations in the
enclosures until successful:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">inherits=TRUE</span></code> by default:</p>
<ul>
<li><p><strong class="command">exists</strong>,</p></li>
<li><p><strong class="command">get</strong>,</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">inherits=FALSE</span></code> by default:</p>
<ul>
<li><p><strong class="command">assign</strong>,</p></li>
<li><p><strong class="command">rm</strong> (remove).</p></li>
</ul>
</li>
</ul>
</div>
</section>
<section id="looking-for-functions">
<h3><span class="section-number">16.2.4. </span>Looking for functions<a class="headerlink" href="#looking-for-functions" title="Link to this heading">#</a></h3>
<p>Interestingly, if a name is used instead of a function to be called,
the object sought is always<a class="footnote-reference brackets" href="#footc" id="id15" role="doc-noteref"><span class="fn-bracket">[</span>10<span class="fn-bracket">]</span></a> of the mode <code class="docutils literal notranslate"><span class="pre">function</span></code>.</p>
<p>Consider an expression similar to the above, but this
time including the name <code class="docutils literal notranslate"><span class="pre">y</span></code> playing a different role:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">expr_y2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">quote</span><span class="p">(</span><span class="nf">y</span><span class="p">())</span><span class="w">  </span><span class="c1"># a call to something named `y`</span>
<span class="nf">eval</span><span class="p">(</span><span class="n">expr_y2</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">e4</span><span class="p">)</span>
<span class="c1">## [1] &quot;a function `y` in e3&quot;</span>
</pre></div>
</div>
<p>In other words, what we used here was not:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">get</span><span class="p">(</span><span class="s">&quot;y&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">e4</span><span class="p">)</span>
<span class="c1">## [1] &quot;spam&quot;</span>
</pre></div>
</div>
<p>but:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">get</span><span class="p">(</span><span class="s">&quot;y&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">e4</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="o">=</span><span class="s">&quot;function&quot;</span><span class="p">)</span>
<span class="c1">## function() &quot;a function `y` in e3&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong class="command">name</strong><code class="code docutils literal notranslate"><span class="pre">()</span></code>,
<code class="docutils literal notranslate"><span class="pre">&quot;name&quot;()</span></code>,
and `<code class="docutils literal notranslate"><span class="pre">name</span></code>`<code class="docutils literal notranslate"><span class="pre">()</span></code>
are synonymous.
However, the first expression is acceptable
only if <code class="docutils literal notranslate"><span class="pre">name</span></code> is syntactically valid.</p>
</div>
</section>
<section id="inspecting-the-search-path">
<span id="sec-search-path"></span><h3><span class="section-number">16.2.5. </span>Inspecting the search path<a class="headerlink" href="#inspecting-the-search-path" title="Link to this heading">#</a></h3>
<p>Going back to our expression involving a relational operator:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">expr_comp</span>
<span class="c1">## x &lt; &quot;eggs&quot;</span>
</pre></div>
</div>
<p>Why does the following work as expected?</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">eval</span><span class="p">(</span><span class="n">expr_comp</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">e3</span><span class="p">)</span><span class="w">  </span><span class="c1"># &quot;bacon&quot; &lt; &quot;eggs&quot;</span>
<span class="c1">## [1] TRUE</span>
</pre></div>
</div>
<p>Well, we have gathered all the bits to understand it now.
Namely, `<strong class="command">&lt;</strong>` is a function that is looked up in the following way:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">get</span><span class="p">(</span><span class="s">&quot;&lt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">e3</span><span class="p">,</span><span class="w"> </span><span class="n">inherits</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="o">=</span><span class="s">&quot;function&quot;</span><span class="p">)</span>
<span class="c1">## function (e1, e2)  .Primitive(&quot;&lt;&quot;)</span>
</pre></div>
</div>
<p>It is reachable from <code class="docutils literal notranslate"><span class="pre">e3</span></code>, which means that
<code class="docutils literal notranslate"><span class="pre">e3</span></code> also has an enclosing environment.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">parent.env</span><span class="p">(</span><span class="n">e3</span><span class="p">)</span>
<span class="c1">## &lt;environment: R_GlobalEnv&gt;</span>
</pre></div>
</div>
<p>This is our global namespace, which was the current environment
when <code class="docutils literal notranslate"><span class="pre">e3</span></code> was created. Still, we did not define `<strong class="command">&lt;</strong>` there.
It means that the global environment also has an enclosure.</p>
<div style="margin-top: 1em"></div><p>We can explore the whole <em>search path</em>
by starting at the global environment and following
the enclosures recursively.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">ecur</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">globalenv</span><span class="p">()</span><span class="w">  </span><span class="c1"># starting point</span>
<span class="n">repeat</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="nf">paste0</span><span class="p">(</span><span class="nf">format</span><span class="p">(</span><span class="n">ecur</span><span class="p">),</span><span class="w"> </span><span class="s">&quot; (&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">attr</span><span class="p">(</span><span class="n">ecur</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;name&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="p">))</span><span class="w">  </span><span class="c1"># pretty-print</span>

<span class="w">    </span><span class="nf">if </span><span class="p">(</span><span class="nf">exists</span><span class="p">(</span><span class="s">&quot;&lt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">ecur</span><span class="p">,</span><span class="w"> </span><span class="n">inherits</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">))</span><span class="w">  </span><span class="c1"># look for `&lt;`</span>
<span class="w">        </span><span class="nf">cat</span><span class="p">(</span><span class="nf">strrep</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span><span class="w"> </span><span class="m">25</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;`&lt;` found here!&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;\n&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="n">ecur</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">parent.env</span><span class="p">(</span><span class="n">ecur</span><span class="p">)</span><span class="w">  </span><span class="c1"># advance to its enclosure</span>
<span class="p">}</span>
<span class="c1">## &lt;environment: R_GlobalEnv&gt; ()</span>
<span class="c1">## &lt;environment: 0x55b5bd046760&gt; (.marekstuff)</span>
<span class="c1">## &lt;environment: package:stats&gt; (package:stats)</span>
<span class="c1">## &lt;environment: package:graphics&gt; (package:graphics)</span>
<span class="c1">## &lt;environment: package:grDevices&gt; (package:grDevices)</span>
<span class="c1">## &lt;environment: package:utils&gt; (package:utils)</span>
<span class="c1">## &lt;environment: package:datasets&gt; (package:datasets)</span>
<span class="c1">## &lt;environment: package:methods&gt; (package:methods)</span>
<span class="c1">## &lt;environment: 0x55b5baffeb48&gt; (Autoloads)</span>
<span class="c1">## &lt;environment: base&gt; ()                          `&lt;` found here!</span>
<span class="c1">## &lt;environment: R_EmptyEnv&gt; ()</span>
<span class="c1">## Error in parent.env(ecur): the empty environment has no parent</span>
</pre></div>
</div>
<p>Underneath the global environment, there is a whole list of
attached packages:</p>
<ol class="arabic simple">
<li><p>packages attached by the user (<strong class="program">.marekstuff</strong>
is used internally in the process of evaluating code in this book),</p></li>
<li><p>default packages (<a class="reference internal" href="170-function.html#sec-default-packages"><span class="std std-numref">Section 7.3.1.1</span></a>),</p></li>
<li><p>(**) <strong class="program">Autoloads</strong> (for the promises-to-load R packages;
compare <strong class="command">help</strong><code class="code docutils literal notranslate"><span class="pre">(&quot;autoload&quot;)</span></code>; it is a technicality we may safely ignore here),</p></li>
<li><p>the <strong class="program">base</strong> package, which we can access directly by
calling <strong class="command">baseenv</strong>; it is where most of the <em>fundamental</em>
functions from the previous chapters reside,</p></li>
<li><p>the <em>empty</em> environment (<strong class="command">emptyenv</strong>),
which is the only one followed by nil
(the loop would turn out endless otherwise).</p></li>
</ol>
<p>It comes at no surprise that the `<strong class="command">&lt;</strong>` operator has been found
in the <strong class="program">base</strong> package.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>On a side note, the reason why this operation failed:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">e2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.environment</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">&quot;spam&quot;</span><span class="p">))</span><span class="w">  </span><span class="c1"># to recall</span>
<span class="nf">eval</span><span class="p">(</span><span class="n">expr_comp</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">e2</span><span class="p">)</span>
<span class="c1">## Error in x &lt; &quot;eggs&quot;: could not find function &quot;&lt;&quot;</span>
</pre></div>
</div>
<p>is because <strong class="command">as.environment</strong> sets the enclosing environment to:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">parent.env</span><span class="p">(</span><span class="n">e2</span><span class="p">)</span>
<span class="c1">## &lt;environment: R_EmptyEnv&gt;</span>
</pre></div>
</div>
<p>See also <strong class="command">list2env</strong> which gives greater control over this
(cf. its <code class="docutils literal notranslate"><span class="pre">parent</span></code> argument).</p>
</div>
</section>
<section id="attaching-to-and-detaching-from-the-search-path">
<span id="sec-attach"></span><h3><span class="section-number">16.2.6. </span>Attaching to and detaching from the search path<a class="headerlink" href="#attaching-to-and-detaching-from-the-search-path" title="Link to this heading">#</a></h3>
<p>In <a class="reference internal" href="170-function.html#sec-packages"><span class="std std-numref">Section 7.3.1</span></a>, we mentioned that we can access
the objects exported by a package without attaching them to the search path
by using the <strong class="program">pkg</strong><code class="code docutils literal notranslate"><span class="pre">::object</span></code> syntax,
which loads the package if necessary.
For instance:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">tools</span><span class="o">::</span><span class="nf">toTitleCase</span><span class="p">(</span><span class="s">&quot;`tools` not attached to the search path&quot;</span><span class="p">)</span>
<span class="c1">## [1] &quot;`tools` not Attached to the Search Path&quot;</span>
</pre></div>
</div>
<p>However:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">toTitleCase</span><span class="p">(</span><span class="s">&quot;nope&quot;</span><span class="p">)</span>
<span class="c1">## Error in toTitleCase(&quot;nope&quot;): could not find function &quot;toTitleCase&quot;</span>
</pre></div>
</div>
<p>It did not work because <strong class="command">toTitleCase</strong> is not reachable
from the current environment.</p>
<p>Let us inspect the current search path:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">search</span><span class="p">()</span>
<span class="c1">##  [1] &quot;.GlobalEnv&quot;        &quot;.marekstuff&quot;       &quot;package:stats&quot;</span>
<span class="c1">##  [4] &quot;package:graphics&quot;  &quot;package:grDevices&quot; &quot;package:utils&quot;</span>
<span class="c1">##  [7] &quot;package:datasets&quot;  &quot;package:methods&quot;   &quot;Autoloads&quot;</span>
<span class="c1">## [10] &quot;package:base&quot;</span>
</pre></div>
</div>
<p>Some might find writing “<strong class="program">pkg</strong><code class="code docutils literal notranslate"><span class="pre">::</span></code>” inconvenient.
Thus, we can call <strong class="command">library</strong> to attach the package
to the search path immediately below the global environment.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="s">&quot;tools&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The search path becomes (see <a class="reference internal" href="#fig-search-path"><span class="std std-numref">Figure 16.3</span></a> for an illustration):</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">search</span><span class="p">()</span>
<span class="c1">##  [1] &quot;.GlobalEnv&quot;        &quot;package:tools&quot;     &quot;.marekstuff&quot;</span>
<span class="c1">##  [4] &quot;package:stats&quot;     &quot;package:graphics&quot;  &quot;package:grDevices&quot;</span>
<span class="c1">##  [7] &quot;package:utils&quot;     &quot;package:datasets&quot;  &quot;package:methods&quot;</span>
<span class="c1">## [10] &quot;Autoloads&quot;         &quot;package:base&quot;</span>
</pre></div>
</div>
<figure class="align-default" id="id37">
<span id="fig-search-path"></span><img alt="../_images/search-path.png" src="../_images/search-path.png" />
<figcaption>
<p><span class="caption-number">Figure 16.3 </span><span class="caption-text">The search path after attaching the <strong class="program">tools</strong> package.</span><a class="headerlink" href="#id37" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>Therefore, what follows, now works as expected:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">toTitleCase</span><span class="p">(</span><span class="s">&quot;Nobody expects the Spanish Inquisition&quot;</span><span class="p">)</span>
<span class="c1">## [1] &quot;Nobody Expects the Spanish Inquisition&quot;</span>
</pre></div>
</div>
<p>We can use <strong class="command">detach</strong><a class="footnote-reference brackets" href="#footunload" id="id16" role="doc-noteref"><span class="fn-bracket">[</span>11<span class="fn-bracket">]</span></a>
to remove an item from the search path.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">head</span><span class="p">(</span><span class="nf">search</span><span class="p">())</span><span class="w">  </span><span class="c1"># before detach</span>
<span class="c1">## [1] &quot;.GlobalEnv&quot;        &quot;package:tools&quot;     &quot;.marekstuff&quot;</span>
<span class="c1">## [4] &quot;package:stats&quot;     &quot;package:graphics&quot;  &quot;package:grDevices&quot;</span>
<span class="nf">detach</span><span class="p">(</span><span class="s">&quot;package:tools&quot;</span><span class="p">)</span>
<span class="nf">head</span><span class="p">(</span><span class="nf">search</span><span class="p">())</span><span class="w">  </span><span class="c1"># not there anymore</span>
<span class="c1">## [1] &quot;.GlobalEnv&quot;        &quot;.marekstuff&quot;       &quot;package:stats&quot;</span>
<span class="c1">## [4] &quot;package:graphics&quot;  &quot;package:grDevices&quot; &quot;package:utils&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We can also plug arbitrary environments<a class="footnote-reference brackets" href="#footattachenv" id="id17" role="doc-noteref"><span class="fn-bracket">[</span>12<span class="fn-bracket">]</span></a> and named lists
into the search path. Recalling that data frames are built on the latter
(<a class="reference internal" href="240-data-frame.html#sec-df-representation"><span class="std std-numref">Section 12.1.6</span></a>), some users rely on this technique
save a few keystrokes.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">attach</span><span class="p">(</span><span class="n">iris</span><span class="p">)</span>
<span class="nf">head</span><span class="p">(</span><span class="nf">search</span><span class="p">(),</span><span class="w"> </span><span class="m">3</span><span class="p">)</span>
<span class="c1">## [1] &quot;.GlobalEnv&quot;  &quot;iris&quot;        &quot;.marekstuff&quot;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">iris</span></code> list was converted to an environment,
and the necessary enclosures were set accordingly:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">str</span><span class="p">(</span><span class="nf">parent.env</span><span class="p">(</span><span class="nf">globalenv</span><span class="p">()))</span>
<span class="c1">## &lt;environment: 0x55b5bdcb8a10&gt;</span>
<span class="c1">##  - attr(*, &quot;name&quot;)= chr &quot;iris&quot;</span>
<span class="nf">str</span><span class="p">(</span><span class="nf">parent.env</span><span class="p">(</span><span class="nf">parent.env</span><span class="p">(</span><span class="nf">globalenv</span><span class="p">())))</span>
<span class="c1">## &lt;environment: 0x55b5bd046760&gt;</span>
<span class="c1">##  - attr(*, &quot;name&quot;)= chr &quot;.marekstuff&quot;</span>
</pre></div>
</div>
<p>We can now write:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">head</span><span class="p">(</span><span class="n">Petal.Width</span><span class="o">/</span><span class="n">Sepal.Width</span><span class="p">)</span><span class="w">  </span><span class="c1"># iris[[&quot;Petal.Width&quot;]]/iris[[&quot;Sepal.Width&quot;]]</span>
<span class="c1">## [1] 0.057143 0.066667 0.062500 0.064516 0.055556 0.102564</span>
</pre></div>
</div>
<p>Overall, attaching data frames is discouraged,
especially outside the interactive mode. Let us not be too lazy.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">detach</span><span class="p">(</span><span class="n">iris</span><span class="p">)</span><span class="w">  </span><span class="c1"># such a relief</span>
</pre></div>
</div>
</div>
</section>
<section id="masking-shadowing-objects-from-down-under">
<span id="sec-shadowing"></span><h3><span class="section-number">16.2.7. </span>Masking (shadowing) objects from down under<a class="headerlink" href="#masking-shadowing-objects-from-down-under" title="Link to this heading">#</a></h3>
<p>An assignment via `<strong class="command">&lt;-</strong>`
creates a binding in the <em>current</em> environment.
Therefore, even if the name to bind exists somewhere on the search
path, it will not be modified. Instead, a new name will be created.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">eval</span><span class="p">(</span><span class="nf">quote</span><span class="p">(</span><span class="s">&quot;spam&quot;</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="s">&quot;eggs&quot;</span><span class="p">))</span>
<span class="c1">## [1] FALSE</span>
</pre></div>
</div>
<p>Here, we rely on `<strong class="command">&lt;</strong>` from the base environment.
Withal, we can create an object of the same name in the current
(global) context:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">`&lt;`</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">e1</span><span class="p">,</span><span class="w"> </span><span class="n">e2</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="nf">warning</span><span class="p">(</span><span class="s">&quot;This is not the base `&lt;`, mate.&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kc">NA</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now we have two different functions of the same name. When we evaluate
an expression within the current environment or any of its descendants,
the new name <em>shadows</em> the base one:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="s">&quot;spam&quot;</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="s">&quot;eggs&quot;</span><span class="w">  </span><span class="c1"># evaluate in the global environment</span>
<span class="c1">## Warning in &quot;spam&quot; &lt; &quot;eggs&quot;: This is not the base `&lt;`, mate.</span>
<span class="c1">## [1] NA</span>
<span class="nf">eval</span><span class="p">(</span><span class="nf">quote</span><span class="p">(</span><span class="s">&quot;spam&quot;</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="s">&quot;eggs&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">e5</span><span class="p">)</span><span class="w">  </span><span class="c1"># its enclosure&#39;s enclosure is global</span>
<span class="c1">## Warning in &quot;spam&quot; &lt; &quot;eggs&quot;: This is not the base `&lt;`, mate.</span>
<span class="c1">## [1] NA</span>
</pre></div>
</div>
<p>But we can still call the original function directly:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">base</span><span class="o">::</span><span class="nf">`&lt;`</span><span class="p">(</span><span class="s">&quot;spam&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;eggs&quot;</span><span class="p">)</span>
<span class="c1">## [1] FALSE</span>
</pre></div>
</div>
<p>It is also reachable from within the current environment’s ancestors:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">eval</span><span class="p">(</span><span class="nf">quote</span><span class="p">(</span><span class="s">&quot;spam&quot;</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="s">&quot;eggs&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="nf">parent.env</span><span class="p">(</span><span class="nf">globalenv</span><span class="p">()))</span>
<span class="c1">## [1] FALSE</span>
</pre></div>
</div>
<div style="margin-top: 1em"></div><p>Before proceeding any further, let us clean up after ourselves.
Otherwise, we will be asking for trouble.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">rm</span><span class="p">(</span><span class="s">&quot;&lt;&quot;</span><span class="p">)</span><span class="w">  </span><span class="c1"># removes `&lt;` from the global environment</span>
</pre></div>
</div>
<div style="margin-top: 1em"></div><p>An attached package may introduce some object names that are
also available elsewhere. For instance:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="s">&quot;stringx&quot;</span><span class="p">)</span>
<span class="c1">## Attaching package: &#39;stringx&#39;</span>
<span class="c1">## The following objects are masked from &#39;package:base&#39;: casefold, chartr,</span>
<span class="c1">##     endsWith, gregexec, gregexpr, grep, grepl, gsub, ISOdate, ISOdatetime,</span>
<span class="c1">##     nchar, nzchar, paste, paste0, regexec, regexpr, sprintf, startsWith,</span>
<span class="c1">##     strftime, strptime, strrep, strsplit, strtrim, strwrap, sub, substr,</span>
<span class="c1">##     substr&lt;-, substring, substring&lt;-, Sys.time, tolower, toupper, trimws,</span>
<span class="c1">##     xtfrm, xtfrm.default</span>
</pre></div>
</div>
<p>Therefore, in the current context, we have what follows:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">toupper</span><span class="p">(</span><span class="s">&quot;Groß&quot;</span><span class="p">)</span><span class="w">  </span><span class="c1"># stringx::toupper</span>
<span class="c1">## [1] &quot;GROSS&quot;</span>
<span class="n">base</span><span class="o">::</span><span class="nf">toupper</span><span class="p">(</span><span class="s">&quot;Groß&quot;</span><span class="p">)</span>
<span class="c1">## [1] &quot;GROß&quot;</span>
</pre></div>
</div>
<div style="margin-top: 1em"></div><p>Sometimes<a class="footnote-reference brackets" href="#footpkglock" id="id18" role="doc-noteref"><span class="fn-bracket">[</span>13<span class="fn-bracket">]</span></a>, we can use
<strong class="command">assign</strong><code class="code docutils literal notranslate"><span class="pre">(...,</span> <span class="pre">inherits=TRUE)</span></code>
or its synonym, `<strong class="command">&lt;&lt;-</strong>`, to modify the <em>existing</em>
binding. A new binding is only created if necessary.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Let us attach the <code class="docutils literal notranslate"><span class="pre">iris</span></code> data frame (named list) to the search
path again:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">attach</span><span class="p">(</span><span class="n">iris</span><span class="p">)</span>
<span class="n">Sepal.Length</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0</span>
</pre></div>
</div>
<p>We did not modify the original <code class="docutils literal notranslate"><span class="pre">iris</span></code> nor
its converted-to-an-environment copy that we can find in the search
path. Instead, a new vector named <code class="docutils literal notranslate"><span class="pre">Sepal.Length</span></code> was created
in the current environment:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">exists</span><span class="p">(</span><span class="s">&quot;Sepal.Length&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="nf">globalenv</span><span class="p">(),</span><span class="w"> </span><span class="n">inherits</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span><span class="w">  </span><span class="c1"># it is in global</span>
<span class="c1">## [1] TRUE</span>
<span class="n">Sepal.Length</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w">  </span><span class="c1"># global</span>
<span class="c1">## [1] 0</span>
</pre></div>
</div>
<p>We can verify the above statement as follows:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">rm</span><span class="p">(</span><span class="s">&quot;Sepal.Length&quot;</span><span class="p">)</span><span class="w">  </span><span class="c1"># removes the one in the global environment</span>
<span class="n">Sepal.Length</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w">  </span><span class="c1"># `iris` from the search path</span>
<span class="c1">## [1] 5.1</span>
<span class="n">iris</span><span class="p">[[</span><span class="s">&quot;Sepal.Length&quot;</span><span class="p">]][</span><span class="m">1</span><span class="p">]</span><span class="w">  </span><span class="c1"># the original `iris`</span>
<span class="c1">## [1] 5.1</span>
</pre></div>
</div>
<p>However, we can write:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">Sepal.Length</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;-</span><span class="w"> </span><span class="m">0</span><span class="w">  </span><span class="c1"># uses assign(..., inherits=TRUE)</span>
</pre></div>
</div>
<p>We changed the state of the environment on the search path.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">exists</span><span class="p">(</span><span class="s">&quot;Sepal.Length&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="nf">globalenv</span><span class="p">(),</span><span class="w"> </span><span class="n">inherits</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span><span class="w">  </span><span class="c1"># not in global</span>
<span class="c1">## [1] FALSE</span>
<span class="n">Sepal.Length</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w">  </span><span class="c1"># `iris` from the search path</span>
<span class="c1">## [1] 0</span>
</pre></div>
</div>
<p>Yet, the original <code class="docutils literal notranslate"><span class="pre">iris</span></code> object is left untouched.
There is no mechanism in place that would <em>synchronise</em>
the original data frame and its independent copy on the search path.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">iris</span><span class="p">[[</span><span class="s">&quot;Sepal.Length&quot;</span><span class="p">]][</span><span class="m">1</span><span class="p">]</span><span class="w">  </span><span class="c1"># the original `iris`</span>
<span class="c1">## [1] 5.1</span>
</pre></div>
</div>
<p>It is best to avoid <strong class="command">attach</strong> to avoid confusion.</p>
</div>
</section>
</section>
<section id="closures">
<span id="sec-eval-fun"></span><h2><span class="section-number">16.3. </span>Closures<a class="headerlink" href="#closures" title="Link to this heading">#</a></h2>
<p>So far, we have only covered the rules of evaluating <em>standalone</em>
R expressions. In this section, we look at what happens
<em>inside</em> the invoked functions.</p>
<section id="local-environment">
<h3><span class="section-number">16.3.1. </span>Local environment<a class="headerlink" href="#local-environment" title="Link to this heading">#</a></h3>
<p>When we call a function, a new temporary environment is created.
It is where all argument values<a class="footnote-reference brackets" href="#footlocarg" id="id19" role="doc-noteref"><span class="fn-bracket">[</span>14<span class="fn-bracket">]</span></a> and local variables
are emplaced. This environment is the current one while the function
is being evaluated. After the call, it ceases to exist,
and we return to the previous environment from the call stack.</p>
<p>Consider the following function:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="nf">print</span><span class="p">(</span><span class="nf">ls</span><span class="p">())</span><span class="w">  </span><span class="c1"># list object names in the current environment</span>
<span class="w">    </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">x</span><span class="o">^</span><span class="m">2</span><span class="w">  </span><span class="c1"># creates a new variable</span>
<span class="w">    </span><span class="nf">print</span><span class="p">(</span><span class="nf">sys.frame</span><span class="p">(</span><span class="nf">sys.nframe</span><span class="p">()))</span><span class="w">  </span><span class="c1"># get the ID of the current environment</span>
<span class="w">    </span><span class="nf">str</span><span class="p">(</span><span class="nf">as.list</span><span class="p">(</span><span class="nf">sys.frame</span><span class="p">(</span><span class="nf">sys.nframe</span><span class="p">())))</span><span class="w">  </span><span class="c1"># display its contents</span>
<span class="p">}</span>
</pre></div>
</div>
<p>First call:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">test</span><span class="p">(</span><span class="m">2</span><span class="p">)</span>
<span class="c1">## [1] &quot;x&quot;</span>
<span class="c1">## &lt;environment: 0x55b5bafc58f0&gt;</span>
<span class="c1">## List of 2</span>
<span class="c1">##  $ y: num 4</span>
<span class="c1">##  $ x: num 2</span>
</pre></div>
</div>
<p>Second call:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">test</span><span class="p">(</span><span class="m">3</span><span class="p">)</span>
<span class="c1">## [1] &quot;x&quot;</span>
<span class="c1">## &lt;environment: 0x55b5bcb5cbe0&gt;</span>
<span class="c1">## List of 2</span>
<span class="c1">##  $ y: num 9</span>
<span class="c1">##  $ x: num 3</span>
</pre></div>
</div>
<p>Each time, the current environment is different.
This is why we do not see the <code class="docutils literal notranslate"><span class="pre">y</span></code> variable at the start
of the second call. It is a brilliantly simple implementation
of the storage for local variables.</p>
</section>
<section id="lexical-scope-and-function-closures">
<span id="sec-lexical-scope"></span><h3><span class="section-number">16.3.2. </span>Lexical scope and function closures<a class="headerlink" href="#lexical-scope-and-function-closures" title="Link to this heading">#</a></h3>
<p>We were able to access the <strong class="command">print</strong> function
(amongst others) in the above example. This should make us wonder
what the enclosing environment of that local environment is.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">print_enclosure</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">()</span>
<span class="w">    </span><span class="nf">print</span><span class="p">(</span><span class="nf">parent.env</span><span class="p">(</span><span class="nf">sys.frame</span><span class="p">(</span><span class="nf">sys.nframe</span><span class="p">())))</span>

<span class="nf">print_enclosure</span><span class="p">()</span>
<span class="c1">## &lt;environment: R_GlobalEnv&gt;</span>
</pre></div>
</div>
<p>It is the global environment. Let us invoke the same function
from another one:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">call_print_enclosure</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">()</span>
<span class="w">    </span><span class="nf">print_enclosure</span><span class="p">()</span>

<span class="nf">call_print_enclosure</span><span class="p">()</span>
<span class="c1">## &lt;environment: R_GlobalEnv&gt;</span>
</pre></div>
</div>
<p>It is the global environment again. If R used the so-called
<em>dynamic scoping</em>, we would see the local environment of the
function that invoked the one above. If this was true, we would
have access to the caller’s local variables from within the callee.
But this is not the case.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Objects of the type <code class="docutils literal notranslate"><span class="pre">closure</span></code>, i.e., user-defined<a class="footnote-reference brackets" href="#footprimitive" id="id20" role="doc-noteref"><span class="fn-bracket">[</span>15<span class="fn-bracket">]</span></a> functions,
consist of three components:</p>
<ul class="simple">
<li><p>a list of formal arguments (compare <strong class="command">formals</strong>
in <a class="reference internal" href="320-language.html#sec-body-formals"><span class="std std-numref">Section 15.4.1</span></a>);</p></li>
<li><p>an expression (see <strong class="command">body</strong> in <a class="reference internal" href="320-language.html#sec-body-formals"><span class="std std-numref">Section 15.4.1</span></a>);</p></li>
<li><p>a reference to the <em>associated environment</em> where the function might store
data for further use (see <strong class="command">environment</strong>).</p></li>
</ul>
<p>By default, the associated environment is set to the current
environment where the function was created.</p>
<p>A local environment created during a function’s call
has this associated environment as its closure.</p>
<p>Due to this, we say that R has <em>lexical (static) scope</em>.</p>
</div>
<p>Thence, in the above example, we have:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">environment</span><span class="p">(</span><span class="n">print_enclosure</span><span class="p">)</span><span class="w">  </span><span class="c1"># print the associated environment</span>
<span class="c1">## &lt;environment: R_GlobalEnv&gt;</span>
</pre></div>
</div>
<div class="proof proof-type-example" id="id38">

    <div class="proof-title">
        <span class="proof-type">Example 16.7</span>
        
    </div><div class="proof-content">
<p>Consider the following function that prints out <code class="docutils literal notranslate"><span class="pre">x</span></code> defined outside
of its scope:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">()</span><span class="w"> </span><span class="nf">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>Now:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;x in global&quot;</span>
<span class="nf">test</span><span class="p">()</span>
<span class="c1">## [1] &quot;x in global&quot;</span>
</pre></div>
</div>
<p>It printed out <code class="docutils literal notranslate"><span class="pre">x</span></code> from the <em>user</em> workspace as it is precisely
the environment associated with the function.
However, setting the associated environment to another
one that also happens to define <code class="docutils literal notranslate"><span class="pre">x</span></code> will give a different result:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">environment</span><span class="p">(</span><span class="n">test</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">e3</span><span class="w">  </span><span class="c1"># defined some time ago</span>
<span class="nf">test</span><span class="p">()</span>
<span class="c1">## [1] &quot;bacon&quot;</span>
</pre></div>
</div>
</div></div><div class="proof proof-type-example" id="id39">

    <div class="proof-title">
        <span class="proof-type">Example 16.8</span>
        
    </div><div class="proof-content">
<p>Consider the following example:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="nf">sprintf</span><span class="p">(</span><span class="s">&quot;test: current env: %s\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">format</span><span class="p">(</span><span class="nf">sys.frame</span><span class="p">(</span><span class="nf">sys.nframe</span><span class="p">()))))</span>

<span class="w">    </span><span class="n">subtest</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">e</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sys.frame</span><span class="p">(</span><span class="nf">sys.nframe</span><span class="p">())</span>
<span class="w">        </span><span class="nf">cat</span><span class="p">(</span><span class="nf">sprintf</span><span class="p">(</span><span class="s">&quot;subtest: enclosing env: %s\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">format</span><span class="p">(</span><span class="nf">parent.env</span><span class="p">(</span><span class="n">e</span><span class="p">))))</span>
<span class="w">        </span><span class="nf">cat</span><span class="p">(</span><span class="nf">sprintf</span><span class="p">(</span><span class="s">&quot;x = %s\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;spam&quot;</span>
<span class="w">    </span><span class="nf">subtest</span><span class="p">()</span>
<span class="w">    </span><span class="nf">environment</span><span class="p">(</span><span class="n">subtest</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">globalenv</span><span class="p">()</span>
<span class="w">    </span><span class="nf">subtest</span><span class="p">()</span>
<span class="p">}</span>

<span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;bacon&quot;</span>
<span class="nf">test</span><span class="p">()</span>
<span class="c1">## test: current env: &lt;environment: 0x55b5bbdaed88&gt;</span>
<span class="c1">## subtest: enclosing env: &lt;environment: 0x55b5bbdaed88&gt;</span>
<span class="c1">## x = spam</span>
<span class="c1">## subtest: enclosing env: &lt;environment: R_GlobalEnv&gt;</span>
<span class="c1">## x = bacon</span>
</pre></div>
</div>
<p>Here is what happened.</p>
<ol class="arabic simple">
<li><p>A call to <strong class="command">test</strong> creates a local function <strong class="command">subtest</strong>,
whose associated environment is set to the local frame
of the current call. It is precisely the current environment
where <strong class="command">subtest</strong> was created (because R has lexical scope).</p></li>
<li><p>The above explains why <strong class="command">subtest</strong>
can access the local variable <code class="docutils literal notranslate"><span class="pre">x</span></code> inside its maker.</p></li>
<li><p>Then we change the environment associated with <strong class="command">subtest</strong>
to the global one.</p></li>
<li><p>In the next call to <strong class="command">subtest</strong>, unsurprisingly,
we gain access to <code class="docutils literal notranslate"><span class="pre">x</span></code> in the user workspace.</p></li>
</ol>
</div></div><div class="admonition note">
<p class="admonition-title">Note</p>
<p>In lexical (static) scoping,
which variables a function refers to can be deduced by reading the
function’s body only and not how it is called in other contexts.
This is the theory. Nevertheless, the fact that we can freely modify the
associated environment anywhere can complicate the program analysis greatly.</p>
<p>If we find the rules of lexical scoping complicated,
we should refrain from referring to objects outside of the current
scope (“global” or “non-local” variables”)
except for the functions defined as top-level ones or imported from
external packages. It is what we have been doing most of the time anyway.</p>
</div>
</section>
<section id="application-function-factories">
<span id="sec-function-factory"></span><h3><span class="section-number">16.3.3. </span>Application: Function factories<a class="headerlink" href="#application-function-factories" title="Link to this heading">#</a></h3>
<p>As closures are functions with associated environments,
and the role of environments is to store information,
we can consider closures = functions + data.
We have already seen that in <a class="reference internal" href="210-design.html#sec-closures"><span class="std std-numref">Section 9.4.3</span></a>, where we
mentioned <strong class="command">approxfun</strong>. To recall:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">length.out</span><span class="o">=</span><span class="m">11</span><span class="p">)</span>
<span class="n">f1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">approxfun</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="o">^</span><span class="m">2</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span>
<span class="c1">## function (v)</span>
<span class="c1">## .approxfun(x, y, v, method, yleft, yright, f, na.rm)</span>
<span class="c1">## &lt;environment: 0x55b5bca1cbd8&gt;</span>
</pre></div>
</div>
<p>The variables <code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code>, etc., that <strong class="command">f1</strong>’s source code
refers to, are stored in its associated environment:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">ls</span><span class="p">(</span><span class="n">envir</span><span class="o">=</span><span class="nf">environment</span><span class="p">(</span><span class="n">f1</span><span class="p">))</span>
<span class="c1">## [1] &quot;f&quot;      &quot;method&quot; &quot;na.rm&quot;  &quot;x&quot;      &quot;y&quot;      &quot;yleft&quot;  &quot;yright&quot;</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Routines that return functions whose non-local variables are memorised
in their associated environments are referred to as <em>function factories</em>.</p>
</div>
<div class="proof proof-type-example" id="id40">

    <div class="proof-title">
        <span class="proof-type">Example 16.9</span>
        
    </div><div class="proof-content">
<p>Consider the following function factory:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">gen_power</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="w">    </span><span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="o">^</span><span class="n">p</span><span class="w">  </span><span class="c1"># p references a non-local variable</span>
</pre></div>
</div>
<p>A call to <strong class="command">gen_power</strong> creates a local environment
that defines one variable, <code class="docutils literal notranslate"><span class="pre">p</span></code>, where the argument’s value
is stored. Then, we create a function whose associated environment
(remember that R uses lexical scoping) is that local one.
It is where the reference to the non-local <code class="docutils literal notranslate"><span class="pre">p</span></code> in its body
will be resolved.
This new function is returned by <strong class="command">gen_power</strong> to the caller.
Normally, the local environment would be destroyed, but it is still
used after the call. Thus, it will not be garbage-collected.</p>
<p>Example calls:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">gen_power</span><span class="p">(</span><span class="m">2</span><span class="p">))</span>
<span class="c1">## function(x) x^p</span>
<span class="c1">## &lt;environment: 0x55b5bd3f9348&gt;</span>
<span class="p">(</span><span class="n">cube</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">gen_power</span><span class="p">(</span><span class="m">3</span><span class="p">))</span>
<span class="c1">## function(x) x^p</span>
<span class="c1">## &lt;environment: 0x55b5bd46c670&gt;</span>
<span class="nf">square</span><span class="p">(</span><span class="m">2</span><span class="p">)</span>
<span class="c1">## [1] 4</span>
<span class="nf">cube</span><span class="p">(</span><span class="m">2</span><span class="p">)</span>
<span class="c1">## [1] 8</span>
</pre></div>
</div>
<p>The underlying environment can, of course, be modified:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">assign</span><span class="p">(</span><span class="s">&quot;p&quot;</span><span class="p">,</span><span class="w"> </span><span class="m">7</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="nf">environment</span><span class="p">(</span><span class="n">cube</span><span class="p">))</span>
<span class="nf">cube</span><span class="p">(</span><span class="m">2</span><span class="p">)</span><span class="w">  </span><span class="c1"># so much for the cube</span>
<span class="c1">## [1] 128</span>
</pre></div>
</div>
</div></div><div class="proof proof-type-example" id="id41">

    <div class="proof-title">
        <span class="proof-type">Example 16.10</span>
        
    </div><div class="proof-content">
<p><strong class="command">Negate</strong> is another example of a function factory.
The function it returns stores <strong class="command">f</strong> passed as an argument.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">notall</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">Negate</span><span class="p">(</span><span class="n">all</span><span class="p">)</span>
<span class="nf">notall</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">))</span>
<span class="c1">## [1] TRUE</span>
</pre></div>
</div>
<p>Study its source code:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">print</span><span class="p">(</span><span class="n">Negate</span><span class="p">)</span>
<span class="c1">## function (f)</span>
<span class="c1">## {</span>
<span class="c1">##     f &lt;- match.fun(f)</span>
<span class="c1">##     function(...) !f(...)</span>
<span class="c1">## }</span>
<span class="c1">## &lt;environment: namespace:base&gt;</span>
</pre></div>
</div>
</div></div><div class="proof proof-type-example" id="id42">

    <div class="proof-title">
        <span class="proof-type">Example 16.11</span>
        
    </div><div class="proof-content">
<p>In <span id="id21">[<a class="reference internal" href="999-bibliography.html#id18" title="Ihaka, R. and Gentleman, R. (1996).  R: A language for data analysis and graphics. Journal of Computational and Graphical Statistics, 5(3):299–314. URL: https://www.stat.auckland.ac.nz/~ihaka/downloads/R-paper.pdf, DOI: 10.1080/10618600.1996.10474713.">37</a>]</span>, the following example is given:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">account</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
<span class="w">    </span><span class="nf">list</span><span class="p">(</span>
<span class="w">        </span><span class="n">balance</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nf">function</span><span class="p">()</span><span class="w"> </span><span class="n">total</span><span class="p">,</span>
<span class="w">        </span><span class="n">deposit</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="n">total</span><span class="w"> </span><span class="o">&lt;&lt;-</span><span class="w"> </span><span class="n">total</span><span class="o">+</span><span class="n">amount</span><span class="p">,</span>
<span class="w">        </span><span class="n">withdraw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="n">total</span><span class="w"> </span><span class="o">&lt;&lt;-</span><span class="w"> </span><span class="n">total</span><span class="o">-</span><span class="n">amount</span>
<span class="w">    </span><span class="p">)</span>

<span class="n">Robert</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">account</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span>
<span class="n">Ross</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">account</span><span class="p">(</span><span class="m">500</span><span class="p">)</span>
<span class="n">Robert</span><span class="o">$</span><span class="nf">deposit</span><span class="p">(</span><span class="m">100</span><span class="p">)</span>
<span class="n">Ross</span><span class="o">$</span><span class="nf">withdraw</span><span class="p">(</span><span class="m">150</span><span class="p">)</span>
<span class="n">Robert</span><span class="o">$</span><span class="nf">balance</span><span class="p">()</span>
<span class="c1">## [1] 1100</span>
<span class="n">Ross</span><span class="o">$</span><span class="nf">balance</span><span class="p">()</span>
<span class="c1">## [1] 350</span>
</pre></div>
</div>
<p>We can now fully understand why the above code does what it does.
The return list consists of three functions whose enclosing environment
is the same. <code class="docutils literal notranslate"><span class="pre">account</span></code> somewhat resembles the definition of a class
with three methods and one data field.
No wonder why reference classes (<a class="reference internal" href="#sec-refclass"><span class="std std-numref">Section 16.1.5</span></a>) were introduced
at some point: they are based on the same concept.</p>
</div></div><div class="proof proof-type-exercise" id="id43">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.12</span>
        
    </div><div class="proof-content">
<p>Write a function factory named <strong class="command">gen_counter</strong> which
implements a simple counter that is increased by one on each call thereto.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">gen_counter</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">()</span><span class="w"> </span><span class="n">...to.do...</span>
<span class="n">c1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">gen_counter</span><span class="p">()</span>
<span class="n">c2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">gen_counter</span><span class="p">()</span>
<span class="nf">c</span><span class="p">(</span><span class="nf">c1</span><span class="p">(),</span><span class="w"> </span><span class="nf">c1</span><span class="p">(),</span><span class="w"> </span><span class="nf">c2</span><span class="p">(),</span><span class="w"> </span><span class="nf">c1</span><span class="p">(),</span><span class="w"> </span><span class="nf">c2</span><span class="p">())</span>
<span class="c1">## [1] 1 2 1 3 2</span>
</pre></div>
</div>
<p>Moreover, compose a function that resets a given counter to zero.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">reset_counter</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">counter_fun</span><span class="p">)</span><span class="w"> </span><span class="n">...to.do...</span>
<span class="nf">reset_counter</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span>
<span class="nf">c1</span><span class="p">()</span>
<span class="c1">## [1] 1</span>
</pre></div>
</div>
</div></div></section>
<section id="accessing-the-calling-environment">
<h3><span class="section-number">16.3.4. </span>Accessing the calling environment<a class="headerlink" href="#accessing-the-calling-environment" title="Link to this heading">#</a></h3>
<p>We know that the environment associated with a function
is not necessarily the same as the environment
from which the function was called, sometimes quite confusingly referred
to as the <em>parent frame</em>.</p>
<p>R maintains a whole <em>frame stack</em>. The global environment is assigned
the number 0. Each call to a function increases the stack by one frame,
whereas returning from a call decreases the counter.
To get the current frame number, we call <strong class="command">sys.nframe</strong>.
This is why <strong class="command">sys.frame</strong><code class="code docutils literal notranslate"><span class="pre">(</span></code><strong class="command">sys.nframe</strong><code class="code docutils literal notranslate"><span class="pre">())</span></code>
returns the current environment.</p>
<p>We can fetch the calling environment by referring to
<strong class="command">parent.frame</strong><code class="code docutils literal notranslate"><span class="pre">()</span></code> or
<strong class="command">sys.frame</strong><code class="code docutils literal notranslate"><span class="pre">(</span></code><strong class="command">sys.parent</strong><code class="code docutils literal notranslate"><span class="pre">())</span></code>,
amongst others<a class="footnote-reference brackets" href="#footparentframe" id="id22" role="doc-noteref"><span class="fn-bracket">[</span>16<span class="fn-bracket">]</span></a>.
Thanks to <strong class="command">parent.frame</strong>, we may evaluate arbitrary
expressions in (on behalf of) the calling environment.
Normally, we should never be doing that. However, a few functions
rely on this feature, hence our avid interest in this possibility.</p>
</section>
<section id="package-namespaces">
<span id="sec-package-namespace"></span><h3><span class="section-number">16.3.5. </span>Package namespaces (*)<a class="headerlink" href="#package-namespaces" title="Link to this heading">#</a></h3>
<p>An R package <code class="docutils literal notranslate"><span class="pre">pkg</span></code> defines two environments:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">namespace:pkg</span></code> is where all objects are defined
(functions, vectors, etc.); it is the enclosing environment
of all closures in the package;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">package:pkg</span></code> contains selected<a class="footnote-reference brackets" href="#footexport" id="id23" role="doc-noteref"><span class="fn-bracket">[</span>17<span class="fn-bracket">]</span></a> objects from
<code class="docutils literal notranslate"><span class="pre">namespace:pkg</span></code> that can be accessed by the user;
it can be attached to the search path.</p></li>
</ul>
<p>As an illustration, we will use the example package discussed
in <a class="reference internal" href="170-function.html#sec-src-package"><span class="std std-numref">Section 7.3.1.2</span></a>.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="s">&quot;rpackagedemo&quot;</span><span class="p">)</span><span class="w">  </span><span class="c1"># https://github.com/gagolews/rpackagedemo/</span>
<span class="c1">## Loading required package: tools</span>
</pre></div>
</div>
<p>Here is its <code class="file docutils literal notranslate"><span class="pre">DESCRIPTION</span></code> file:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Package: rpackagedemo
Type: Package
Title: Just a Demo R Package
Version: 1.0.2
Date: 1970-01-01
Author: Anonymous Llama
Maintainer: Unnamed Kangaroo &lt;roo@inthebush.au&gt;
Description: Provides a function named bamboo(), just give it a shot.
License: GPL (&gt;= 2)
Imports: stringx
Depends: tools
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Import</span></code> and <code class="docutils literal notranslate"><span class="pre">Depends</span></code> fields specify which packages
(apart from <strong class="program">base</strong>) ours depends on.
As we can see above, all items in the latter list are attached
to the search path on a call to <strong class="command">library</strong>.</p>
<p>The <code class="file docutils literal notranslate"><span class="pre">NAMESPACE</span></code> file specifies the names imported
from other packages and those that are
expected to be visible to the user:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>importFrom(stringx, sprintf)
importFrom(tools, toTitleCase)
S3method(print, koala)
S3method(print, kangaroo, .a_hidden_method_to_print_a_roo)
export(bamboo)
</pre></div>
</div>
<p>Thus, our package exports one object, a function named <strong class="command">bamboo</strong>
(we will discuss the S3 methods in the next section).
It is included in the <code class="docutils literal notranslate"><span class="pre">package:rpackagedemo</span></code> environment
attached to the search path:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">ls</span><span class="p">(</span><span class="n">envir</span><span class="o">=</span><span class="nf">as.environment</span><span class="p">(</span><span class="s">&quot;package:rpackagedemo&quot;</span><span class="p">))</span><span class="w"> </span><span class="c1"># ls(&quot;package:rpackagedemo&quot;)</span>
<span class="c1">## [1] &quot;bamboo&quot;</span>
</pre></div>
</div>
<p>Let us give it a shot:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">bamboo</span><span class="p">(</span><span class="s">&quot;spanish inquisition&quot;</span><span class="p">)</span><span class="w">  </span><span class="c1"># rpackagedemo::bamboo</span>
<span class="c1">## G&#39;day, Spanish Inquisition!</span>
</pre></div>
</div>
<p>We did not expect this at all, nor that its source code looks like:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">print</span><span class="p">(</span><span class="n">bamboo</span><span class="p">)</span>
<span class="c1">## function (x = &quot;world&quot;)</span>
<span class="c1">## cat(prepare_message(toTitleCase(x)))</span>
<span class="c1">## &lt;environment: namespace:rpackagedemo&gt;</span>
</pre></div>
</div>
<p>We see a call to <strong class="command">toTitleCase</strong> (most likely from
<strong class="program">tools</strong>, and this is indeed the case). Also,
<strong class="command">prepare_message</strong> is invoked but it is not
listed in the package’s imports (see the <code class="file docutils literal notranslate"><span class="pre">NAMESPACE</span></code> file).
We definitely cannot access it directly:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">prepare_message</span>
<span class="c1">## Error in eval(expr, envir, enclos): object &#39;prepare_message&#39; not found</span>
</pre></div>
</div>
<p>It is the package’s <em>internal</em> function, which is
included in the <code class="docutils literal notranslate"><span class="pre">namespace:rpackagedemo</span></code> environment.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">e</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">environment</span><span class="p">(</span><span class="n">rpackagedemo</span><span class="o">::</span><span class="n">bamboo</span><span class="p">))</span><span class="w">  </span><span class="c1"># or getNamespace(&quot;rpackagedemo&quot;)</span>
<span class="c1">## &lt;environment: namespace:rpackagedemo&gt;</span>
<span class="nf">ls</span><span class="p">(</span><span class="n">envir</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
<span class="c1">## [1] &quot;bamboo&quot;          &quot;prepare_message&quot; &quot;print.koala&quot;</span>
</pre></div>
</div>
<p>We can fetch it via the `<strong class="command">:::</strong>` operator:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">print</span><span class="p">(</span><span class="n">rpackagedemo</span><span class="o">:::</span><span class="n">prepare_message</span><span class="p">)</span>
<span class="c1">## function (x)</span>
<span class="c1">## sprintf(&quot;G&#39;day, %s!\n&quot;, x)</span>
<span class="c1">## &lt;environment: namespace:rpackagedemo&gt;</span>
</pre></div>
</div>
<p>All functions defined in a package have the corresponding namespace
as their associated environment. As a consequence, <strong class="command">bamboo</strong> can
refer to <strong class="command">prepare_message</strong> directly.</p>
<div style="margin-top: 1em"></div><p>It will be educative to inspect the enclosure of <code class="docutils literal notranslate"><span class="pre">namespace:rpackagedemo</span></code>:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">e</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">parent.env</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
<span class="c1">## &lt;environment: 0x55b5bb9e39e0&gt;</span>
<span class="c1">## attr(,&quot;name&quot;)</span>
<span class="c1">## [1] &quot;imports:rpackagedemo&quot;</span>
<span class="nf">ls</span><span class="p">(</span><span class="n">envir</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
<span class="c1">## [1] &quot;sprintf&quot;     &quot;toTitleCase&quot;</span>
</pre></div>
</div>
<p>It is the environment carrying the bindings to all the imported
objects. This is why our package can also refer to
<strong class="program">stringx</strong><code class="code docutils literal notranslate"><span class="pre">::</span></code><strong class="command">sprintf</strong>
and <strong class="program">tools</strong><code class="code docutils literal notranslate"><span class="pre">::</span></code><strong class="command">toTitleCase</strong>.
Its enclosure is the <em>namespace</em> of the <strong class="program">base</strong> package
(not to be confused with <code class="docutils literal notranslate"><span class="pre">package:base</span></code>):</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">e</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">parent.env</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
<span class="c1">## &lt;environment: namespace:base&gt;</span>
</pre></div>
</div>
<p>The next enclosure is, interestingly, the global environment:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">e</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">parent.env</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
<span class="c1">## &lt;environment: R_GlobalEnv&gt;</span>
</pre></div>
</div>
<p>Then, of course, the whole search path follows;
see <a class="reference internal" href="#fig-namespace-search-path"><span class="std std-numref">Figure 16.4</span></a> for an illustration.</p>
<figure class="align-default" id="id44">
<span id="fig-namespace-search-path"></span><img alt="../_images/namespace-search-path.png" src="../_images/namespace-search-path.png" />
<figcaption>
<p><span class="caption-number">Figure 16.4 </span><span class="caption-text">A search path for an example package. Dashed lines represent environments associated with closures, whereas solid lines denote enclosing environments. References to objects within each package are resolved inside their respective namespaces.</span><a class="headerlink" href="#id44" title="Link to this image">#</a></p>
</figcaption>
</figure>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>(**)
All environments related to packages are locked, which means that we cannot
change any bindings inside their frames; compare <strong class="command">help</strong><code class="code docutils literal notranslate"><span class="pre">(&quot;lockEnvironment&quot;)</span></code>.
In the extremely rare event of our needing to <em>patch</em> an existing
function within an already loaded package,
we can call <strong class="command">unlockBinding</strong> followed by <strong class="command">assign</strong>
to change its definition.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">new_message</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="nf">sprintf</span><span class="p">(</span><span class="s">&quot;Nobody expects %s!\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="n">e</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">getNamespace</span><span class="p">(</span><span class="s">&quot;rpackagedemo&quot;</span><span class="p">)</span>
<span class="nf">environment</span><span class="p">(</span><span class="n">new_message</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">e</span><span class="w">  </span><span class="c1"># set enclosing environment (very important!)</span>
<span class="nf">unlockBinding</span><span class="p">(</span><span class="s">&quot;prepare_message&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="nf">assign</span><span class="p">(</span><span class="s">&quot;prepare_message&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">new_message</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="nf">rm</span><span class="p">(</span><span class="s">&quot;new_message&quot;</span><span class="p">)</span>
<span class="nf">bamboo</span><span class="p">(</span><span class="s">&quot;the spanish inquisition&quot;</span><span class="p">)</span>
<span class="c1">## Nobody expects The Spanish Inquisition!</span>
</pre></div>
</div>
<p>R is indeed a quite hackable language (except in the cases where
it is not).</p>
</div>
<div class="proof proof-type-exercise" id="id45">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.13</span>
        
    </div><div class="proof-content">
<p>(**)
A function or a package might register certain functions
(<em>hooks</em>) to be called on various events, e.g.,
attaching a package to the search patch;
see <strong class="command">help</strong><code class="code docutils literal notranslate"><span class="pre">(&quot;setHook&quot;)</span></code> and <strong class="command">help</strong><code class="code docutils literal notranslate"><span class="pre">(&quot;.onAttach&quot;)</span></code>.</p>
<ol class="arabic simple">
<li><p>Inspect the source code of <strong class="command">plot.new</strong> and notice a
reference to a hook named <code class="docutils literal notranslate"><span class="pre">&quot;before.plot.new&quot;</span></code>. Try setting such
a hook yourself (e.g., one that changes some of the graphics parameters
discussed in <a class="reference internal" href="250-graphics.html#sec-graphics-par"><span class="std std-numref">Section 13.2</span></a>)
and see what happens on each call to a plotting function.</p></li>
<li><p>Define the <strong class="command">.onLoad</strong>, <strong class="command">.onAttach</strong>,
<strong class="command">.onUnload</strong>, and <strong class="command">.onDetach</strong> functions
in your own R package and take note of when they are invoked.</p></li>
</ol>
</div></div><div class="proof proof-type-exercise" id="id46">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.14</span>
        
    </div><div class="proof-content">
<p>(**)
For the purpose of this book, we have registered a custom <code class="docutils literal notranslate"><span class="pre">&quot;before.plot.new&quot;</span></code>
hook that sets our favourite graphics parameters that we listed
in <a class="reference internal" href="250-graphics.html#sec-plot-usr-axis"><span class="std std-numref">Section 13.2.3</span></a>. Moreover, to obtain a white grid on a grey
background, e.g., in <a class="reference internal" href="250-graphics.html#fig-mysettsgraph"><span class="std std-numref">Figure 13.13</span></a>,
we modified <strong class="command">plot.window</strong> slightly.
Apply similar hacks to the <strong class="program">graphics</strong> package so that
its outputs suit your taste better.</p>
</div></div></section>
<section id="s3-method-lookup-by-usemethod">
<span id="sec-use-method"></span><h3><span class="section-number">16.3.6. </span>S3 method lookup by <strong class="command">UseMethod</strong> (*)<a class="headerlink" href="#s3-method-lookup-by-usemethod" title="Link to this heading">#</a></h3>
<p>Let us go back to the <strong class="program">rpackagedemo</strong> example.
Inspecting the <code class="file docutils literal notranslate"><span class="pre">NAMESPACE</span></code> file, we see that the package defines
two <strong class="command">print</strong> methods for objects of the classes
<code class="docutils literal notranslate"><span class="pre">koala</span></code> and <code class="docutils literal notranslate"><span class="pre">kangaroo</span></code>.</p>
<p>The package is still attached to the search path. Therefore, we can access
these methods via a call to the corresponding generic:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">print</span><span class="p">(</span><span class="nf">structure</span><span class="p">(</span><span class="s">&quot;Tiny Teddy&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">class</span><span class="o">=</span><span class="s">&quot;koala&quot;</span><span class="p">))</span>
<span class="c1">## This is a cute koala, Tiny Teddy</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">structure</span><span class="p">(</span><span class="s">&quot;Moike&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">class</span><span class="o">=</span><span class="s">&quot;kangaroo&quot;</span><span class="p">))</span>
<span class="c1">## This is a very naughty kangaroo, Moike</span>
</pre></div>
</div>
<p>The package does not make the definitions of these S3 methods
available to the user, at least not directly.
It is not the first time when we have experienced such an obscuration.
In the first case, the method is simply hidden in the package namespace
because it was not marked for exportation in the <code class="file docutils literal notranslate"><span class="pre">NAMESPACE</span></code> file.
However, it is still available under the expected name:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">rpackagedemo</span><span class="o">:::</span><span class="n">print.koala</span>
<span class="c1">## function (x, ...)</span>
<span class="c1">## cat(sprintf(&quot;This is a cute koala, %s\n&quot;, x))</span>
<span class="c1">## &lt;environment: namespace:rpackagedemo&gt;</span>
</pre></div>
</div>
<p>In the second case, the method appears under a very different identifier:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">rpackagedemo</span><span class="o">:::</span><span class="n">.a_hidden_method_to_print_a_roo</span>
<span class="c1">## function (x, ...)</span>
<span class="c1">## cat(sprintf(&quot;This is a very naughty kangaroo, %s\n&quot;, x))</span>
<span class="c1">## &lt;environment: namespace:rpackagedemo&gt;</span>
</pre></div>
</div>
<p>Since the base <strong class="command">UseMethod</strong> is still able to find them, we suspect
that there must be a global register of all S3 methods.
And this is indeed the case. We can use <strong class="command">getS3method</strong> to get access
to what is available via <strong class="command">UseMethod</strong>:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">getS3method</span><span class="p">(</span><span class="s">&quot;print&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;kangaroo&quot;</span><span class="p">)</span>
<span class="c1">## function (x, ...)</span>
<span class="c1">## cat(sprintf(&quot;This is a very naughty kangaroo, %s\n&quot;, x))</span>
<span class="c1">## &lt;environment: namespace:rpackagedemo&gt;</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Overall, the search for methods is performed in two places:</p>
<ol class="arabic">
<li><p>in the environment where the generic is called (the current
environment); this is why defining <strong class="command">print.kangaroo</strong>
in the current scope will use this method instead
of the one from the package:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">print.kangaroo</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kc">...</span><span class="p">)</span><span class="w"> </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Nobody expects&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">structure</span><span class="p">(</span><span class="s">&quot;the Spanish Inquisition&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">class</span><span class="o">=</span><span class="s">&quot;kangaroo&quot;</span><span class="p">))</span>
<span></span><span class="c1">## Nobody expects the Spanish Inquisition</span>
</pre></div>
</div>
</li>
<li><p>in the internal S3 methods table (registration database).</p></li>
</ol>
<p>See <strong class="command">help</strong><code class="code docutils literal notranslate"><span class="pre">(&quot;UseMethod&quot;)</span></code> for more details.
Also, recall that in <a class="reference internal" href="220-s3.html#sec-built-in-generics"><span class="std std-numref">Section 10.2.3</span></a>, we said that
<strong class="command">UseMethod</strong> is not the only way to perform method dispatching.
There are also internal generics and group generic functions;
see <strong class="command">help</strong><code class="code docutils literal notranslate"><span class="pre">(&quot;InternalMethods&quot;)</span></code> and <strong class="command">help</strong><code class="code docutils literal notranslate"><span class="pre">(&quot;groupGeneric&quot;)</span></code>.</p>
</div>
<div class="proof proof-type-exercise" id="id47">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.15</span>
        
    </div><div class="proof-content">
<p>(*)
Study the source code of <strong class="command">getS3method</strong>.
Note the reference to the <code class="docutils literal notranslate"><span class="pre">base::</span></code>`<code class="docutils literal notranslate"><span class="pre">.__S3MethodsTable__.</span></code>` object
which is for R’s internal use (we ought not to tinker with it directly).
Moreover, study the <strong class="command">.S3method</strong> function with which we can
define new S3 methods not necessarily following the
<strong class="command">generic.classname</strong> convention.</p>
</div></div></section>
</section>
<section id="exercises">
<h2><span class="section-number">16.4. </span>Exercises<a class="headerlink" href="#exercises" title="Link to this heading">#</a></h2>
<div class="proof proof-type-exercise" id="id48">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.16</span>
        
    </div><div class="proof-content">
<p>Asking too many questions is not very charismatic,
but challenge yourself by trying to find the answer to the following.</p>
<ul class="simple">
<li><p>What is the role of a frame in an environment?</p></li>
<li><p>What is the role of an enclosing environment? How to read
it or set it?</p></li>
<li><p>What is the difference between a named list and an environment?</p></li>
<li><p>What functions and operators work on named lists but cannot be
applied on environments?</p></li>
<li><p>What do we mean by saying that environments are not passed by value
to R functions?</p></li>
<li><p>What do we mean by saying that objects are sometimes copied on demand?</p></li>
<li><p>What happens if a name listed in an expression to be evaluated
is not found in the current environment?</p></li>
<li><p>How and what kind of objects can we attach to the search path?</p></li>
<li><p>What happens if we have two identical object names on the search path?</p></li>
<li><p>What do we mean by saying that package namespaces are locked when loaded?</p></li>
<li><p>What is the current environment when we evaluate an expression
“on the console”?</p></li>
<li><p>What is the difference between `<strong class="command">&lt;-</strong>` and `<strong class="command">&lt;&lt;-</strong>`?</p></li>
<li><p>Do packages have their own search paths?</p></li>
<li><p>What is a function closure?</p></li>
<li><p>What is the difference between the dynamic and the lexical scope?</p></li>
<li><p>When evaluating a function, how is the enclosure of the current
(local) environment determined? Is it the same as the calling
environment? How to get it/them programmatically?</p></li>
<li><p>How and why function factories work?</p></li>
<li><p>(*) What is the difference between the <code class="docutils literal notranslate"><span class="pre">package:pkg</span></code> and
<code class="docutils literal notranslate"><span class="pre">namespace:pkg</span></code> environments?</p></li>
<li><p>How do we fetch the definition of an S3 method that does not seem
to be available directly via the
standard accessor <strong class="command">generic.classname</strong>?</p></li>
<li><p>(*) <strong class="program">base</strong><code class="code docutils literal notranslate"><span class="pre">::</span></code><strong class="command">print.data.frame</strong> calls
<strong class="program">base</strong><code class="code docutils literal notranslate"><span class="pre">::</span></code><strong class="command">format.data.frame</strong> (directly).
Will the introduction of <strong class="command">print.data.frame</strong>
in the current environment affect how data frames are printed?</p></li>
<li><p>(*) On the other hand,
<strong class="program">base</strong><code class="code docutils literal notranslate"><span class="pre">::</span></code><strong class="command">format.data.frame</strong>
calls the generic <strong class="program">base</strong><code class="code docutils literal notranslate"><span class="pre">::</span></code><strong class="command">format</strong>
on all the input data frame’s
columns. Will the overloading of the particular methods affect
how data frames are printed?</p></li>
</ul>
</div></div><div class="proof proof-type-exercise" id="id49">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.17</span>
        
    </div><div class="proof-content">
<p>Calling:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">pkg</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">available.packages</span><span class="p">()</span>
<span class="n">pkg</span><span class="p">[,</span><span class="w"> </span><span class="s">&quot;Package&quot;</span><span class="p">]</span><span class="w">  </span><span class="c1"># a list of the names of available packages</span>
<span class="n">pkg</span><span class="p">[,</span><span class="w"> </span><span class="s">&quot;Depends&quot;</span><span class="p">]</span><span class="w">  </span><span class="c1"># dependencies</span>
</pre></div>
</div>
<p>gives the list of available packages and their dependencies.
Convert the dependency lists to a list of character vectors
(preferably using regular expressions; see <a class="reference internal" href="160-character.html#sec-regex"><span class="std std-numref">Section 6.2.4</span></a>).</p>
<p>Then, generate a list of reverse dependencies: what packages depend
on each given package.</p>
<p>Use an object of the type <code class="docutils literal notranslate"><span class="pre">environment</span></code> (a hash table)
to map the package names to numeric IDs (indexes).
It will significantly speed up the whole process
(compare it to a named list-based implementation).</p>
</div></div><div class="proof proof-type-exercise" id="id50">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.18</span>
        
    </div><div class="proof-content">
<p>According to <span id="id24">[<a class="reference internal" href="999-bibliography.html#id11" title="R Development Core Team. (2023).  R Language Definition. URL: https://CRAN.R-project.org/doc/manuals/r-release/R-lang.html.">67</a>]</span>, compare
also <a class="reference internal" href="210-design.html#sec-replacementfun"><span class="std std-numref">Section 9.3.6</span></a>, a call to:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;&lt;-</span><span class="w"> </span><span class="n">v</span>
</pre></div>
</div>
<p>translates to:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">`*tmp*`</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="nf">parent.env</span><span class="p">(),</span><span class="w"> </span><span class="n">inherits</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
<span class="n">x</span><span class="w"> </span><span class="o">&lt;&lt;-</span><span class="w"> </span><span class="nf">`add&lt;-`</span><span class="p">(</span><span class="n">`*tmp*`</span><span class="p">,</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w">  </span><span class="c1"># note: not f(`*tmp*`)</span>
<span class="nf">rm</span><span class="p">(</span><span class="n">`*tmp*`</span><span class="p">)</span>
</pre></div>
</div>
<p>Given:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">`add&lt;-`</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">where</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">x</span><span class="p">[</span><span class="n">where</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">where</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">value</span>
<span class="w">    </span><span class="n">x</span><span class="w">  </span><span class="c1"># the modified object that will replace the original one</span>
<span class="p">}</span>

<span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">5</span>
<span class="n">f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">);</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">==</span><span class="m">-3</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;-</span><span class="w"> </span><span class="m">1000</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
<p>explain why we get the following results:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">f</span><span class="p">()</span>
<span class="c1">## [1] -1 -2 -3 -4 -5</span>
<span class="nf">print</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="c1">## [1]    1    2 1003    4    5</span>
</pre></div>
</div>
</div></div><hr class="footnotes docutils" />
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="footdf" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">1</a><span class="fn-bracket">]</span></span>
<p>Not to be confused with a <em>data frame</em>, i.e., an object (list)
of the S3 class <code class="docutils literal notranslate"><span class="pre">data.frame</span></code>; see <a class="reference internal" href="240-data-frame.html#chap-data-frame"><span class="std std-numref">Chapter 12</span></a>.</p>
</aside>
<aside class="footnote brackets" id="footencpar" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id3">2</a><span class="fn-bracket">]</span></span>
<p>Some also call it a <em>parent</em> environment,
but we will not. We will try following the nomenclature
established in Section 3.2 of <span id="id25">[<a class="reference internal" href="999-bibliography.html#id16" title="Abelson, H., Sussman, G.J., and Sussman, J. (1996).  Structure and Interpretation of Computer Programs. MIT Press.">1</a>]</span>.
Note that there is a bit of a mess in the R documentation
regarding how enclosing environments are referred to.</p>
</aside>
<aside class="footnote brackets" id="footquickhash" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id5">3</a><span class="fn-bracket">]</span></span>
<p>In hash tables, element lookup, insertion, and deletion
take amortised <span class="math">\(O(1)\)</span> time.</p>
</aside>
<aside class="footnote brackets" id="footlisttime" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id6">4</a><span class="fn-bracket">]</span></span>
<p>Accessing elements by position (numeric index)
in lists takes <span class="math">\(O(1)\)</span> time. The worst-case scenario for the element
lookup by name is linear with respect to the container size (when
the item is not found). Also, inserting new elements at the end takes
amortised <span class="math">\(O(1)\)</span> time.</p>
</aside>
<aside class="footnote brackets" id="footdelayed" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id7">5</a><span class="fn-bracket">]</span></span>
<p>Delayed (on demand); see below.</p>
</aside>
<aside class="footnote brackets" id="foottrickery" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id8">6</a><span class="fn-bracket">]</span></span>
<p>We do not count all the tricks we can do at
the C language level (<a class="reference internal" href="310-compiled.html#chap-compiled"><span class="std std-numref">Chapter 14</span></a>).
In R, the distinction between pass-by-value and pass-by-reference
is slightly more complicated because of the lazy evaluation
of arguments (the call-by-need strategy; <a class="reference internal" href="340-lazy.html#chap-lazy"><span class="std std-numref">Chapter 17</span></a>).
We are making an idealisation for didactic purposes here.</p>
</aside>
<aside class="footnote brackets" id="footr5" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id9">7</a><span class="fn-bracket">]</span></span>
<p>Some call them R5, but we will not.</p>
</aside>
<aside class="footnote brackets" id="footlisp" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id11">8</a><span class="fn-bracket">]</span></span>
<p>That is why everyone <em>serious</em>
about R programming should add the
<em>Structure and Interpretation of Computer Programs</em>
<span id="id26">[<a class="reference internal" href="999-bibliography.html#id16" title="Abelson, H., Sussman, G.J., and Sussman, J. (1996).  Structure and Interpretation of Computer Programs. MIT Press.">1</a>]</span> to their reading list.
Also, R is not the only known marriage between
statistics and Lisp-like languages; see also LISP-STAT
<span id="id27">[<a class="reference internal" href="999-bibliography.html#id17" title="Tierney, L. (1990).  LISP-STAT: An Object-Oriented Environment for Statistical Computing and Dynamic Graphics. Wiley.">54</a>]</span>.</p>
</aside>
<aside class="footnote brackets" id="footassign" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id14">9</a><span class="fn-bracket">]</span></span>
<p>Let us, for now, take for granted that `<strong class="command">&lt;-</strong>`
is accessible from the current context and denotes the assignment.</p>
</aside>
<aside class="footnote brackets" id="footc" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id15">10</a><span class="fn-bracket">]</span></span>
<p>This is why we can write “<code class="docutils literal notranslate"><span class="pre">c</span> <span class="pre">&lt;-</span> </code><strong class="command">c</strong><code class="code docutils literal notranslate"><span class="pre">(1,</span> <span class="pre">2)</span></code>”
and then still be able to call <strong class="command">c</strong> to create another
vector.</p>
</aside>
<aside class="footnote brackets" id="footunload" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id16">11</a><span class="fn-bracket">]</span></span>
<p>Which does not unload the package from memory, though;
see <strong class="command">unload</strong> (possibly combined with
<strong class="command">library.dynam.unload</strong>).</p>
</aside>
<aside class="footnote brackets" id="footattachenv" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id17">12</a><span class="fn-bracket">]</span></span>
<p>Or we should rather say, environment frames.
When an environment is attached to the search path,
it is duplicated so that the changes made to the original environment
are not reflected in the copy. Then, its previous enclosure is discarded.
After all, we want a series of recursive calls to
<strong class="command">parent.env</strong> to form the whole search path.</p>
</aside>
<aside class="footnote brackets" id="footpkglock" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id18">13</a><span class="fn-bracket">]</span></span>
<p>We normally cannot modify package namespaces.
As we will mention in <a class="reference internal" href="#sec-package-namespace"><span class="std std-numref">Section 16.3.5</span></a>,
they are automatically locked.</p>
</aside>
<aside class="footnote brackets" id="footlocarg" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id19">14</a><span class="fn-bracket">]</span></span>
<p>Function arguments are initially unevaluated;
see <a class="reference internal" href="340-lazy.html#chap-lazy"><span class="std std-numref">Chapter 17</span></a>.</p>
</aside>
<aside class="footnote brackets" id="footprimitive" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id20">15</a><span class="fn-bracket">]</span></span>
<p>There are two other types of functions:
a <code class="docutils literal notranslate"><span class="pre">special</span></code> is an internal function that
does not necessarily evaluate its arguments (e.g.,
<strong class="command">switch</strong>, <strong class="command">if</strong>, or <strong class="command">quote</strong>;
compare also <a class="reference internal" href="340-lazy.html#chap-lazy"><span class="std std-numref">Chapter 17</span></a>),
whereas a <code class="docutils literal notranslate"><span class="pre">builtin</span></code> always evaluates its actual parameters,
e.g., <strong class="command">sum</strong>.</p>
</aside>
<aside class="footnote brackets" id="footparentframe" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id22">16</a><span class="fn-bracket">]</span></span>
<p>In <strong class="command">help</strong><code class="code docutils literal notranslate"><span class="pre">(&quot;sys.parent&quot;)</span></code>, we read that
the parent frame number, as returned by <strong class="command">sys.parent</strong><code class="code docutils literal notranslate"><span class="pre">()</span></code>,
is not necessarily equal to <strong class="command">sys.nframe</strong><code class="code docutils literal notranslate"><span class="pre">()-1</span></code>.
It is certainly true if we are at the top (global) level.</p>
</aside>
<aside class="footnote brackets" id="footexport" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id23">17</a><span class="fn-bracket">]</span></span>
<p>Exported using the <code class="docutils literal notranslate"><span class="pre">export</span></code> or <code class="docutils literal notranslate"><span class="pre">exportPattern</span></code>
directive in the package’s <code class="file docutils literal notranslate"><span class="pre">NAMESPACE</span></code> file;
see Section 1 of <span id="id28">[<a class="reference internal" href="999-bibliography.html#id15" title="R Development Core Team. (2023).  Writing R Extensions. URL: https://CRAN.R-project.org/doc/manuals/r-release/R-exts.html.">63</a>]</span>.</p>
</aside>
</aside>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="340-lazy.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title"><span class="section-number">17. </span>Lazy evaluation (**)</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="320-language.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title"><span class="section-number">15. </span>Unevaluated expressions (*)</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
              
              
              Copyright &#169; 2022–2023 by <a href="https://www.gagolewski.com/">Marek Gagolewski</a>.
              Some rights reserved. Licensed under <a href='https://creativecommons.org/licenses/by-nc-nd/4.0'>CC BY-NC-ND 4.0</a>.
              Built with <a href="https://sphinx-doc.org/">Sphinx</a>
              and a customised <a href="https://github.com/pradyunsg/furo">Furo</a> theme.
              Last updated on 2023-11-07T09:46:25+1100.
              This site will never display any ads: it is a non-profit project.
              It does not collect any data.
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            In this chapter
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">16. Environments and evaluation (*)</a><ul>
<li><a class="reference internal" href="#frames-environments-as-object-containers">16.1. Frames: Environments as object containers</a><ul>
<li><a class="reference internal" href="#printing">16.1.1. Printing</a></li>
<li><a class="reference internal" href="#environments-vs-named-lists">16.1.2. Environments vs named lists</a></li>
<li><a class="reference internal" href="#hash-maps-fast-element-lookup-by-name">16.1.3. Hash maps: Fast element lookup by name</a></li>
<li><a class="reference internal" href="#call-by-value-copy-on-demand-not-for-environments">16.1.4. Call by value, copy on demand: Not for environments</a></li>
<li><a class="reference internal" href="#a-note-on-reference-classes">16.1.5. A note on reference classes (**)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-environment-model-of-evaluation">16.2. The environment model of evaluation</a><ul>
<li><a class="reference internal" href="#getting-the-current-environment">16.2.1. Getting the current environment</a></li>
<li><a class="reference internal" href="#enclosures-enclosures-thereof-etc">16.2.2. Enclosures, enclosures thereof, etc.</a></li>
<li><a class="reference internal" href="#missing-names-are-sought-in-enclosing-environments">16.2.3. Missing names are sought in enclosing environments</a></li>
<li><a class="reference internal" href="#looking-for-functions">16.2.4. Looking for functions</a></li>
<li><a class="reference internal" href="#inspecting-the-search-path">16.2.5. Inspecting the search path</a></li>
<li><a class="reference internal" href="#attaching-to-and-detaching-from-the-search-path">16.2.6. Attaching to and detaching from the search path</a></li>
<li><a class="reference internal" href="#masking-shadowing-objects-from-down-under">16.2.7. Masking (shadowing) objects from down under</a></li>
</ul>
</li>
<li><a class="reference internal" href="#closures">16.3. Closures</a><ul>
<li><a class="reference internal" href="#local-environment">16.3.1. Local environment</a></li>
<li><a class="reference internal" href="#lexical-scope-and-function-closures">16.3.2. Lexical scope and function closures</a></li>
<li><a class="reference internal" href="#application-function-factories">16.3.3. Application: Function factories</a></li>
<li><a class="reference internal" href="#accessing-the-calling-environment">16.3.4. Accessing the calling environment</a></li>
<li><a class="reference internal" href="#package-namespaces">16.3.5. Package namespaces (*)</a></li>
<li><a class="reference internal" href="#s3-method-lookup-by-usemethod">16.3.6. S3 method lookup by <strong class="command">UseMethod</strong> (*)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exercises">16.4. Exercises</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=838c6f80"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=32e29ea5"></script>
    <script src="../_static/proof.js"></script>
    <script src="../_static/katex.min.js?v=deb2f140"></script>
    <script src="../_static/auto-render.min.js?v=8b9f325c"></script>
    <script src="../_static/katex_autorenderer.js?v=bebc588a"></script>
    </body>
</html>